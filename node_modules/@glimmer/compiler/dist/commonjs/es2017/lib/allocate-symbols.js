'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.SymbolAllocator = undefined;

var _util = require('@glimmer/util');

class SymbolAllocator {
    constructor(ops) {
        this.ops = ops;
        this.symbolStack = new _util.Stack();
    }
    process() {
        let out = [];
        let { ops } = this;
        for (let i = 0; i < ops.length; i++) {
            let op = ops[i];
            let result = this.dispatch(op);
            if (result === undefined) {
                out.push(op);
            } else {
                out.push(result);
            }
        }
        return out;
    }
    dispatch(op) {
        let name = op[0];
        let operand = op[1];
        return this[name](operand);
    }
    get symbols() {
        return this.symbolStack.current;
    }
    startProgram(op) {
        this.symbolStack.push(op['symbols']);
    }
    endProgram(_op) {
        this.symbolStack.pop();
    }
    startBlock(op) {
        this.symbolStack.push(op['symbols']);
    }
    endBlock(_op) {
        this.symbolStack.pop();
    }
    flushElement(op) {
        this.symbolStack.push(op['symbols']);
    }
    closeElement(_op) {
        this.symbolStack.pop();
    }
    closeComponent(_op) {
        this.symbolStack.pop();
    }
    closeDynamicComponent(_op) {
        this.symbolStack.pop();
    }
    attrSplat(_op) {
        return ['attrSplat', this.symbols.allocateBlock('attrs')];
    }
    get(op) {
        let [name, rest] = op;
        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            let head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            let head = this.symbols.allocateNamed(name);
            return ['get', [head, rest]];
        } else {
            return ['maybeLocal', [name, ...rest]];
        }
    }
    maybeGet(op) {
        let [name, rest] = op;
        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            let head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            let head = this.symbols.allocateNamed(name);
            return ['get', [head, rest]];
        } else if (rest.length === 0) {
            return ['unknown', name];
        } else {
            return ['maybeLocal', [name, ...rest]];
        }
    }
    yield(op) {
        if (op === 0) {
            throw new Error('Cannot yield to this');
        }
        return ['yield', this.symbols.allocateBlock(op)];
    }
    debugger(_op) {
        return ['debugger', this.symbols.getEvalInfo()];
    }
    hasBlock(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlock this');
        }
        return ['hasBlock', this.symbols.allocateBlock(op)];
    }
    hasBlockParams(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlockParams this');
        }
        return ['hasBlockParams', this.symbols.allocateBlock(op)];
    }
    partial(_op) {
        return ['partial', this.symbols.getEvalInfo()];
    }
    text(_op) {}
    comment(_op) {}
    openComponent(_op) {}
    openElement(_op) {}
    openSplattedElement(_op) {}
    staticArg(_op) {}
    dynamicArg(_op) {}
    staticAttr(_op) {}
    trustingAttr(_op) {}
    dynamicAttr(_op) {}
    modifier(_op) {}
    append(_op) {}
    block(_op) {}
    literal(_op) {}
    helper(_op) {}
    unknown(_op) {}
    maybeLocal(_op) {}
    prepareArray(_op) {}
    prepareObject(_op) {}
    concat(_op) {}
}
exports.SymbolAllocator = SymbolAllocator;
function isLocal(name, symbols) {
    return symbols && symbols.has(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsb2NhdGUtc3ltYm9scy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9hbGxvY2F0ZS1zeW1ib2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFHQSxBQUFPLEFBQUUsQUFBSyxBQUFFLEFBQU0sQUFBRSxBQUFNLEFBQWUsQUFBQyxBQWlCOUMsQUFBTTs7O2dCQUlnQixBQUFnQixLQUFoQjthQUFHLE1BRmYsQUFFWSxBQUFHLEFBQWE7YUFGakIsY0FBRyxBQUFJLEFBQUssQUFBZSxBQUFDLEFBRVIsQUFBQztBQUV4QyxBQUFPO2NBQ0w7WUFBSSxBQUFHLE1BQVksQUFBRSxBQUFDLEFBQ3RCO1lBQUksRUFBRSxBQUFHLEFBQUUsUUFBRyxBQUFJLEFBQUMsQUFFbkI7YUFBSyxJQUFJLEFBQUMsSUFBRyxBQUFDLEdBQUUsQUFBQyxJQUFHLEFBQUcsSUFBQyxBQUFNLFFBQUUsQUFBQyxBQUFFLEtBQUUsQUFDbkM7Z0JBQUksQUFBRSxLQUFHLEFBQUcsSUFBQyxBQUFDLEFBQUMsQUFBQyxBQUNoQjtnQkFBSSxBQUFNLFNBQUcsQUFBSSxLQUFDLEFBQVEsU0FBQyxBQUFFLEFBQUMsQUFBQyxBQUUvQjtnQkFBSSxBQUFNLFdBQUssQUFBUyxXQUFFLEFBQ3hCLEFBQUc7b0JBQUMsQUFBSSxLQUFDLEFBQVcsQUFBQyxBQUFDLEFBQ3ZCO21CQUFNLEFBQ0wsQUFBRztvQkFBQyxBQUFJLEtBQUMsQUFBYSxBQUFDLEFBQUMsQUFDekI7QUFDRjtBQUVEO2VBQU8sQUFBRyxBQUFDLEFBQ2IsQUFBQztBQUVELEFBQVE7YUFBaUIsQUFBSyxJQUM1QjtZQUFJLEFBQUksT0FBRyxBQUFFLEdBQUMsQUFBQyxBQUFDLEFBQUMsQUFDakI7WUFBSSxBQUFPLFVBQUcsQUFBRSxHQUFDLEFBQUMsQUFBQyxBQUFDLEFBRXBCO2VBQVEsQUFBSSxLQUFDLEFBQUksQUFBUyxNQUFDLEFB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QUFDLEFBQVMsS0FBRyxBQUFDLEFBQ3JCO0FBN0pDOztBQStKRixpQkFBaUIsQUFBWSxNQUFFLEFBQW9CLFNBQ2pEO1dBQU8sQUFBTyxXQUFJLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBSSxBQUFDLEFBQUMsQUFDdEMsQUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBpbGVyT3BzLCBQcm9jZXNzb3IsIE9wLCBPcE5hbWUsIFRlbXBsYXRlQ29tcGlsZXJPcHMsIFBhdGhIZWFkIH0gZnJvbSAnLi9jb21waWxlci1vcHMnO1xuaW1wb3J0IHsgQVNUIH0gZnJvbSAnQGdsaW1tZXIvc3ludGF4JztcbmltcG9ydCB7IE9wdGlvbiwgT3BhcXVlIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBTdGFjaywgZXhwZWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBTeW1ib2xUYWJsZSB9IGZyb20gJy4vdGVtcGxhdGUtdmlzaXRvcic7XG5cbmV4cG9ydCB0eXBlIEluVmFyaWFibGUgPSBQYXRoSGVhZDtcbmV4cG9ydCB0eXBlIE91dFZhcmlhYmxlID0gbnVtYmVyO1xuXG5leHBvcnQgdHlwZSBPdXRPcDxLIGV4dGVuZHMga2V5b2YgQ29tcGlsZXJPcHM8T3V0VmFyaWFibGU+ID0gT3BOYW1lPiA9IE9wPFxuICBPdXRWYXJpYWJsZSxcbiAgQ29tcGlsZXJPcHM8T3V0VmFyaWFibGU+LFxuICBLXG4+O1xuZXhwb3J0IHR5cGUgSW5PcDxLIGV4dGVuZHMga2V5b2YgVGVtcGxhdGVDb21waWxlck9wcyA9IGtleW9mIFRlbXBsYXRlQ29tcGlsZXJPcHM+ID0gT3A8XG4gIFBhdGhIZWFkLFxuICBUZW1wbGF0ZUNvbXBpbGVyT3BzLFxuICBLXG4+O1xuXG5leHBvcnQgY2xhc3MgU3ltYm9sQWxsb2NhdG9yXG4gIGltcGxlbWVudHMgUHJvY2Vzc29yPENvbXBpbGVyT3BzPEluVmFyaWFibGU+LCBPdXRWYXJpYWJsZSwgQ29tcGlsZXJPcHM8T3V0VmFyaWFibGU+PiB7XG4gIHByaXZhdGUgc3ltYm9sU3RhY2sgPSBuZXcgU3RhY2s8U3ltYm9sVGFibGU+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvcHM6IEFycmF5PEluT3A+KSB7fVxuXG4gIHByb2Nlc3MoKTogT3V0T3BbXSB7XG4gICAgbGV0IG91dDogT3V0T3BbXSA9IFtdO1xuICAgIGxldCB7IG9wcyB9ID0gdGhpcztcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3BzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgb3AgPSBvcHNbaV07XG4gICAgICBsZXQgcmVzdWx0ID0gdGhpcy5kaXNwYXRjaChvcCk7XG5cbiAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBvdXQucHVzaChvcCBhcyBPdXRPcCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXQucHVzaChyZXN1bHQgYXMgYW55KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgZGlzcGF0Y2g8TyBleHRlbmRzIEluT3A+KG9wOiBPKTogT3BhcXVlIHtcbiAgICBsZXQgbmFtZSA9IG9wWzBdO1xuICAgIGxldCBvcGVyYW5kID0gb3BbMV07XG5cbiAgICByZXR1cm4gKHRoaXNbbmFtZV0gYXMgYW55KShvcGVyYW5kKTtcbiAgfVxuXG4gIGdldCBzeW1ib2xzKCk6IFN5bWJvbFRhYmxlIHtcbiAgICByZXR1cm4gZXhwZWN0KHRoaXMuc3ltYm9sU3RhY2suY3VycmVudCwgJ0V4cGVjdGVkIGEgc3ltYm9sIHRhYmxlIG9uIHRoZSBzdGFjaycpO1xuICB9XG5cbiAgc3RhcnRQcm9ncmFtKG9wOiBBU1QuUHJvZ3JhbSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucHVzaChvcFsnc3ltYm9scyddKTtcbiAgfVxuXG4gIGVuZFByb2dyYW0oX29wOiBudWxsKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIHN0YXJ0QmxvY2sob3A6IEFTVC5Qcm9ncmFtKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wdXNoKG9wWydzeW1ib2xzJ10pO1xuICB9XG5cbiAgZW5kQmxvY2soX29wOiBudWxsKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIGZsdXNoRWxlbWVudChvcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wdXNoKG9wWydzeW1ib2xzJ10pO1xuICB9XG5cbiAgY2xvc2VFbGVtZW50KF9vcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIGNsb3NlQ29tcG9uZW50KF9vcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIGNsb3NlRHluYW1pY0NvbXBvbmVudChfb3A6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBhdHRyU3BsYXQoX29wOiBPcHRpb248SW5WYXJpYWJsZT4pOiBPdXRPcDwnYXR0clNwbGF0Jz4ge1xuICAgIHJldHVybiBbJ2F0dHJTcGxhdCcsIHRoaXMuc3ltYm9scy5hbGxvY2F0ZUJsb2NrKCdhdHRycycpXTtcbiAgfVxuXG4gIGdldChvcDogW0luVmFyaWFibGUsIHN0cmluZ1tdXSk6IE91dE9wPCdnZXQnIHwgJ21heWJlTG9jYWwnPiB7XG4gICAgbGV0IFtuYW1lLCByZXN0XSA9IG9wO1xuXG4gICAgaWYgKG5hbWUgPT09IDApIHtcbiAgICAgIHJldHVybiBbJ2dldCcsIFswLCByZXN0XV07XG4gICAgfVxuXG4gICAgaWYgKGlzTG9jYWwobmFtZSwgdGhpcy5zeW1ib2xzKSkge1xuICAgICAgbGV0IGhlYWQgPSB0aGlzLnN5bWJvbHMuZ2V0KG5hbWUpO1xuICAgICAgcmV0dXJuIFsnZ2V0JywgW2hlYWQsIHJlc3RdXTtcbiAgICB9IGVsc2UgaWYgKG5hbWVbMF0gPT09ICdAJykge1xuICAgICAgbGV0IGhlYWQgPSB0aGlzLnN5bWJvbHMuYWxsb2NhdGVOYW1lZChuYW1lKTtcbiAgICAgIHJldHVybiBbJ2dldCcsIFtoZWFkLCByZXN0XV07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbJ21heWJlTG9jYWwnLCBbbmFtZSwgLi4ucmVzdF1dO1xuICAgIH1cbiAgfVxuXG4gIG1heWJlR2V0KG9wOiBbSW5WYXJpYWJsZSwgc3RyaW5nW11dKTogT3V0T3A8J2dldCcgfCAndW5rbm93bicgfCAnbWF5YmVMb2NhbCc+IHtcbiAgICBsZXQgW25hbWUsIHJlc3RdID0gb3A7XG5cbiAgICBpZiAobmFtZSA9PT0gMCkge1xuICAgICAgcmV0dXJuIFsnZ2V0JywgWzAsIHJlc3RdXTtcbiAgICB9XG5cbiAgICBpZiAoaXNMb2NhbChuYW1lLCB0aGlzLnN5bWJvbHMpKSB7XG4gICAgICBsZXQgaGVhZCA9IHRoaXMuc3ltYm9scy5nZXQobmFtZSk7XG4gICAgICByZXR1cm4gWydnZXQnLCBbaGVhZCwgcmVzdF1dO1xuICAgIH0gZWxzZSBpZiAobmFtZVswXSA9PT0gJ0AnKSB7XG4gICAgICBsZXQgaGVhZCA9IHRoaXMuc3ltYm9scy5hbGxvY2F0ZU5hbWVkKG5hbWUpO1xuICAgICAgcmV0dXJuIFsnZ2V0JywgW2hlYWQsIHJlc3RdXTtcbiAgICB9IGVsc2UgaWYgKHJlc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gWyd1bmtub3duJywgbmFtZV07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbJ21heWJlTG9jYWwnLCBbbmFtZSwgLi4ucmVzdF1dO1xuICAgIH1cbiAgfVxuXG4gIHlpZWxkKG9wOiBJblZhcmlhYmxlKTogT3V0T3A8J3lpZWxkJz4ge1xuICAgIGlmIChvcCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgeWllbGQgdG8gdGhpcycpO1xuICAgIH1cblxuICAgIHJldHVybiBbJ3lpZWxkJywgdGhpcy5zeW1ib2xzLmFsbG9jYXRlQmxvY2sob3ApXTtcbiAgfVxuXG4gIGRlYnVnZ2VyKF9vcDogT3B0aW9uPEluVmFyaWFibGVbXT4pOiBPdXRPcDwnZGVidWdnZXInPiB7XG4gICAgcmV0dXJuIFsnZGVidWdnZXInLCB0aGlzLnN5bWJvbHMuZ2V0RXZhbEluZm8oKV07XG4gIH1cblxuICBoYXNCbG9jayhvcDogSW5WYXJpYWJsZSk6IE91dE9wPCdoYXNCbG9jayc+IHtcbiAgICBpZiAob3AgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGhhc0Jsb2NrIHRoaXMnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gWydoYXNCbG9jaycsIHRoaXMuc3ltYm9scy5hbGxvY2F0ZUJsb2NrKG9wKV07XG4gIH1cblxuICBoYXNCbG9ja1BhcmFtcyhvcDogSW5WYXJpYWJsZSk6IE91dE9wPCdoYXNCbG9ja1BhcmFtcyc+IHtcbiAgICBpZiAob3AgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGhhc0Jsb2NrUGFyYW1zIHRoaXMnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gWydoYXNCbG9ja1BhcmFtcycsIHRoaXMuc3ltYm9scy5hbGxvY2F0ZUJsb2NrKG9wKV07XG4gIH1cblxuICBwYXJ0aWFsKF9vcDogT3B0aW9uPEluVmFyaWFibGVbXT4pOiBPdXRPcDwncGFydGlhbCc+IHtcbiAgICByZXR1cm4gWydwYXJ0aWFsJywgdGhpcy5zeW1ib2xzLmdldEV2YWxJbmZvKCldO1xuICB9XG5cbiAgdGV4dChfb3A6IHN0cmluZykge31cbiAgY29tbWVudChfb3A6IHN0cmluZykge31cbiAgb3BlbkNvbXBvbmVudChfb3A6IEFTVC5FbGVtZW50Tm9kZSkge31cbiAgb3BlbkVsZW1lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHt9XG4gIG9wZW5TcGxhdHRlZEVsZW1lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHt9XG4gIHN0YXRpY0FyZyhfb3A6IHN0cmluZykge31cbiAgZHluYW1pY0FyZyhfb3A6IHN0cmluZykge31cbiAgc3RhdGljQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgdHJ1c3RpbmdBdHRyKF9vcDogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7fVxuICBkeW5hbWljQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgbW9kaWZpZXIoX29wOiBzdHJpbmcpIHt9XG4gIGFwcGVuZChfb3A6IGJvb2xlYW4pIHt9XG4gIGJsb2NrKF9vcDogW3N0cmluZywgbnVtYmVyLCBPcHRpb248bnVtYmVyPl0pIHt9XG4gIGxpdGVyYWwoX29wOiBzdHJpbmcgfCBib29sZWFuIHwgbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkge31cbiAgaGVscGVyKF9vcDogc3RyaW5nKSB7fVxuICB1bmtub3duKF9vcDogc3RyaW5nKSB7fVxuICBtYXliZUxvY2FsKF9vcDogc3RyaW5nW10pIHt9XG4gIHByZXBhcmVBcnJheShfb3A6IG51bWJlcikge31cbiAgcHJlcGFyZU9iamVjdChfb3A6IG51bWJlcikge31cbiAgY29uY2F0KF9vcDogbnVsbCkge31cbn1cblxuZnVuY3Rpb24gaXNMb2NhbChuYW1lOiBzdHJpbmcsIHN5bWJvbHM6IFN5bWJvbFRhYmxlKTogYm9vbGVhbiB7XG4gIHJldHVybiBzeW1ib2xzICYmIHN5bWJvbHMuaGFzKG5hbWUpO1xufVxuIl19