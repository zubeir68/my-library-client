'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.Template = exports.ComponentBlock = exports.TemplateBlock = exports.InlineBlock = exports.Block = undefined;

var _util = require('@glimmer/util');

var _wireFormat = require('@glimmer/wire-format');

class Block {
    constructor() {
        this.statements = [];
    }
    push(statement) {
        this.statements.push(statement);
    }
}
exports.Block = Block;
class InlineBlock extends Block {
    constructor(table) {
        super();
        this.table = table;
    }
    toJSON() {
        return {
            statements: this.statements,
            parameters: this.table.slots
        };
    }
}
exports.InlineBlock = InlineBlock;
class TemplateBlock extends Block {
    constructor(symbolTable) {
        super();
        this.symbolTable = symbolTable;
        this.type = 'template';
        this.yields = new _util.DictSet();
        this.named = new _util.DictSet();
        this.blocks = [];
        this.hasEval = false;
    }
    push(statement) {
        this.statements.push(statement);
    }
    toJSON() {
        return {
            symbols: this.symbolTable.symbols,
            statements: this.statements,
            hasEval: this.hasEval
        };
    }
}
exports.TemplateBlock = TemplateBlock;
class ComponentBlock extends Block {
    constructor(tag, table, selfClosing) {
        super();
        this.tag = tag;
        this.table = table;
        this.selfClosing = selfClosing;
        this.attributes = [];
        this.arguments = [];
        this.inParams = true;
        this.positionals = [];
    }
    push(statement) {
        if (this.inParams) {
            if ((0, _wireFormat.isFlushElement)(statement)) {
                this.inParams = false;
            } else if ((0, _wireFormat.isArgument)(statement)) {
                this.arguments.push(statement);
            } else if ((0, _wireFormat.isAttribute)(statement)) {
                this.attributes.push(statement);
            } else if ((0, _wireFormat.isAttrSplat)(statement)) {
                this.attributes.push(statement);
            } else {
                throw new Error('Compile Error: only parameters allowed before flush-element');
            }
        } else {
            this.statements.push(statement);
        }
    }
    toJSON() {
        let args = this.arguments;
        let keys = args.map(arg => arg[1]);
        let values = args.map(arg => arg[2]);
        let block = this.selfClosing ? null : {
            statements: this.statements,
            parameters: this.table.slots
        };
        return [this.tag, this.attributes, [keys, values], block];
    }
}
exports.ComponentBlock = ComponentBlock;
class Template {
    constructor(symbols) {
        this.block = new TemplateBlock(symbols);
    }
    toJSON() {
        return this.block.toJSON();
    }
}
exports.Template = Template;
class JavaScriptCompiler {
    constructor(opcodes, symbols, options) {
        this.blocks = new _util.Stack();
        this.values = [];
        this.opcodes = opcodes;
        this.template = new Template(symbols);
        this.options = options;
    }
    static process(opcodes, symbols, options) {
        let compiler = new JavaScriptCompiler(opcodes, symbols, options);
        return compiler.process();
    }
    get currentBlock() {
        return this.blocks.current;
    }
    process() {
        this.opcodes.forEach(op => {
            let opcode = op[0];
            let arg = op[1];
            if (!this[opcode]) {
                throw new Error(`unimplemented ${opcode} on JavaScriptCompiler`);
            }
            this[opcode](arg);
        });
        return this.template;
    }
    /// Nesting
    startBlock(program) {
        let block = new InlineBlock(program['symbols']);
        this.blocks.push(block);
    }
    endBlock() {
        let { template, blocks } = this;
        let block = blocks.pop();
        template.block.blocks.push(block.toJSON());
    }
    startProgram() {
        this.blocks.push(this.template.block);
    }
    endProgram() {}
    /// Statements
    text(content) {
        this.push([_wireFormat.Ops.Text, content]);
    }
    append(trusted) {
        this.push([_wireFormat.Ops.Append, this.popValue(), trusted]);
    }
    comment(value) {
        this.push([_wireFormat.Ops.Comment, value]);
    }
    modifier(name) {
        let params = this.popValue();
        let hash = this.popValue();
        this.push([_wireFormat.Ops.Modifier, name, params, hash]);
    }
    block([name, template, inverse]) {
        let params = this.popValue();
        let hash = this.popValue();
        let blocks = this.template.block.blocks;
        false && (0, _util.assert)(typeof template !== 'number' || blocks[template] !== null, 'missing block in the compiler');
        false && (0, _util.assert)(typeof inverse !== 'number' || blocks[inverse] !== null, 'missing block in the compiler');

        this.push([_wireFormat.Ops.Block, name, params, hash, blocks[template], blocks[inverse]]);
    }
    openComponent(element) {
        let tag = this.options && this.options.customizeComponentName ? this.options.customizeComponentName(element.tag) : element.tag;
        let component = new ComponentBlock(tag, element['symbols'], element.selfClosing);
        this.blocks.push(component);
    }
    openSplattedElement(element) {
        let tag = element.tag;
        if (element.blockParams.length > 0) {
            throw new Error(`Compile Error: <${element.tag}> is not a component and doesn't support block parameters`);
        } else {
            this.push([_wireFormat.Ops.OpenSplattedElement, tag]);
        }
    }
    openElement(element) {
        let tag = element.tag;
        if (element.blockParams.length > 0) {
            throw new Error(`Compile Error: <${element.tag}> is not a component and doesn't support block parameters`);
        } else {
            this.push([_wireFormat.Ops.OpenElement, tag]);
        }
    }
    flushElement() {
        this.push([_wireFormat.Ops.FlushElement]);
    }
    closeComponent(_element) {
        if (_element.modifiers.length > 0) {
            throw new Error('Compile Error: Element modifiers are not allowed in components');
        }
        let [tag, attrs, args, block] = this.endComponent();
        this.push([_wireFormat.Ops.Component, tag, attrs, args, block]);
    }
    closeDynamicComponent(_element) {
        let [, attrs, args, block] = this.endComponent();
        this.push([_wireFormat.Ops.DynamicComponent, this.popValue(), attrs, args, block]);
    }
    closeElement(_element) {
        this.push([_wireFormat.Ops.CloseElement]);
    }
    staticAttr([name, namespace]) {
        let value = this.popValue();
        this.push([_wireFormat.Ops.StaticAttr, name, value, namespace]);
    }
    dynamicAttr([name, namespace]) {
        let value = this.popValue();
        this.push([_wireFormat.Ops.DynamicAttr, name, value, namespace]);
    }
    trustingAttr([name, namespace]) {
        let value = this.popValue();
        this.push([_wireFormat.Ops.TrustingAttr, name, value, namespace]);
    }
    staticArg(name) {
        let value = this.popValue();
        this.push([_wireFormat.Ops.StaticArg, name, value]);
    }
    dynamicArg(name) {
        let value = this.popValue();
        this.push([_wireFormat.Ops.DynamicArg, name, value]);
    }
    yield(to) {
        let params = this.popValue();
        this.push([_wireFormat.Ops.Yield, to, params]);
    }
    attrSplat(to) {
        this.push([_wireFormat.Ops.AttrSplat, to]);
    }
    debugger(evalInfo) {
        this.push([_wireFormat.Ops.Debugger, evalInfo]);
        this.template.block.hasEval = true;
    }
    hasBlock(name) {
        this.pushValue([_wireFormat.Ops.HasBlock, name]);
    }
    hasBlockParams(name) {
        this.pushValue([_wireFormat.Ops.HasBlockParams, name]);
    }
    partial(evalInfo) {
        let params = this.popValue();
        this.push([_wireFormat.Ops.Partial, params[0], evalInfo]);
        this.template.block.hasEval = true;
    }
    /// Expressions
    literal(value) {
        if (value === undefined) {
            this.pushValue([_wireFormat.Ops.Undefined]);
        } else {
            this.pushValue(value);
        }
    }
    unknown(name) {
        this.pushValue([_wireFormat.Ops.Unknown, name]);
    }
    get([head, path]) {
        this.pushValue([_wireFormat.Ops.Get, head, path]);
    }
    maybeLocal(path) {
        this.pushValue([_wireFormat.Ops.MaybeLocal, path]);
    }
    concat() {
        this.pushValue([_wireFormat.Ops.Concat, this.popValue()]);
    }
    helper(name) {
        let params = this.popValue();
        let hash = this.popValue();
        this.pushValue([_wireFormat.Ops.Helper, name, params, hash]);
    }
    /// Stack Management Opcodes
    prepareArray(size) {
        let values = [];
        for (let i = 0; i < size; i++) {
            values.push(this.popValue());
        }
        this.pushValue(values);
    }
    prepareObject(size) {
        false && (0, _util.assert)(this.values.length >= size, `Expected ${size} values on the stack, found ${this.values.length}`);

        let keys = new Array(size);
        let values = new Array(size);
        for (let i = 0; i < size; i++) {
            keys[i] = this.popValue();
            values[i] = this.popValue();
        }
        this.pushValue([keys, values]);
    }
    /// Utilities
    endComponent() {
        let component = this.blocks.pop();
        false && (0, _util.assert)(component instanceof ComponentBlock, 'Compiler bug: endComponent() should end a component');

        return component.toJSON();
    }
    push(args) {
        while (args[args.length - 1] === null) {
            args.pop();
        }
        this.currentBlock.push(args);
    }
    pushValue(val) {
        this.values.push(val);
    }
    popValue() {
        false && (0, _util.assert)(this.values.length, 'No expression found on stack');

        return this.values.pop();
    }
}
exports.default = JavaScriptCompiler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiamF2YXNjcmlwdC1jb21waWxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9qYXZhc2NyaXB0LWNvbXBpbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxBQUFPLEFBQUUsQUFBTSxBQUFFLEFBQU0sQUFBZSxBQUFDLEFBQ3ZDLEFBQU8sQUFBRSxBQUFLLEFBQUUsQUFBTyxBQUFVLEFBQU0sQUFBRSxBQUFNLEFBQWUsQUFBQzs7QUFJL0QsQUFBTyxBQVFMLEFBQUcsQUFDSCxBQUFjLEFBQ2QsQUFBVSxBQUNWLEFBQVcsQUFDWCxBQUFXLEFBQ1osQUFBTSxBQUFzQixBQUFDLEFBUzlCLEFBQU07OztrQkFDRzthQUFVLGFBQWdCLEFBQUUsQUFBQyxBQU90QyxBQUFDO0FBSEMsQUFBSTtTQUFDLEFBQW9CLFdBQ3ZCLEFBQUk7YUFBQyxBQUFVLFdBQUMsQUFBSSxLQUFDLEFBQVMsQUFBQyxBQUFDLEFBQ2xDLEFBQUMsQUFDRjtBQUVELEFBQU07QUFWTjs7TUFVeUIsb0JBQVEsQUFBSztnQkFDakIsQUFBdUIsT0FDeEMsQUFBSyxBQUFFLEFBQUM7QUFEUzthQUFLLFFBQUwsQUFBSyxBQUFrQixBQUUxQyxBQUFDO0FBRUQsQUFBTTthQUNKOzt3QkFDYyxBQUFJLEtBQUMsQUFBVSxBQUMzQixBQUFVO3dCQUFFLEFBQUksS0FBQyxBQUFLLE1BRmpCLEFBRWtCLEFBQUssQUFDN0IsQUFBQyxBQUNKLEFBQUMsQUFDRjtBQUpLLEFBQVU7QUFNaEIsQUFBTTtBQVpKOztNQVl5QixzQkFBUSxBQUFLO2dCQU9sQixBQUErQixhQUNqRCxBQUFLLEFBQUUsQUFBQztBQURVO2FBQVcsY0FOeEIsQUFNYSxBQUFXLEFBQW9CO2FBTnhDLE9BQUcsQUFBVSxBQUFDLEFBQ2xCO2FBQU0sU0FBRyxBQUFJLEFBQU8sQUFBVSxBQUFDLEFBQy9CO2FBQUssUUFBRyxBQUFJLEFB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cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXNzZXJ0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBTdGFjaywgRGljdFNldCwgT3B0aW9uLCBleHBlY3QgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IEFTVCB9IGZyb20gJ0BnbGltbWVyL3N5bnRheCc7XG5pbXBvcnQgeyBCbG9ja1N5bWJvbFRhYmxlLCBQcm9ncmFtU3ltYm9sVGFibGUgfSBmcm9tICcuL3RlbXBsYXRlLXZpc2l0b3InO1xuaW1wb3J0IHsgQ29tcGlsZU9wdGlvbnMgfSBmcm9tICcuL3RlbXBsYXRlLWNvbXBpbGVyJztcbmltcG9ydCB7XG4gIFNlcmlhbGl6ZWRJbmxpbmVCbG9jayxcbiAgU2VyaWFsaXplZFRlbXBsYXRlQmxvY2ssXG4gIENvcmUsXG4gIFN0YXRlbWVudCxcbiAgU3RhdGVtZW50cyxcbiAgRXhwcmVzc2lvbixcbiAgRXhwcmVzc2lvbnMsXG4gIE9wcyxcbiAgaXNGbHVzaEVsZW1lbnQsXG4gIGlzQXJndW1lbnQsXG4gIGlzQXR0cmlidXRlLFxuICBpc0F0dHJTcGxhdCxcbn0gZnJvbSAnQGdsaW1tZXIvd2lyZS1mb3JtYXQnO1xuaW1wb3J0IHsgUHJvY2Vzc29yLCBDb21waWxlck9wcywgT3BOYW1lLCBPcCB9IGZyb20gJy4vY29tcGlsZXItb3BzJztcblxuZXhwb3J0IHR5cGUgc3RyID0gc3RyaW5nO1xuZXhwb3J0IHR5cGUgUGFyYW1zID0gQ29yZS5QYXJhbXM7XG5leHBvcnQgdHlwZSBIYXNoID0gQ29yZS5IYXNoO1xuZXhwb3J0IHR5cGUgUGF0aCA9IENvcmUuUGF0aDtcbmV4cG9ydCB0eXBlIFN0YWNrVmFsdWUgPSBFeHByZXNzaW9uIHwgUGFyYW1zIHwgSGFzaCB8IHN0cjtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEJsb2NrIHtcbiAgcHVibGljIHN0YXRlbWVudHM6IFN0YXRlbWVudFtdID0gW107XG5cbiAgYWJzdHJhY3QgdG9KU09OKCk6IE9iamVjdDtcblxuICBwdXNoKHN0YXRlbWVudDogU3RhdGVtZW50KSB7XG4gICAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSW5saW5lQmxvY2sgZXh0ZW5kcyBCbG9jayB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyB0YWJsZTogQmxvY2tTeW1ib2xUYWJsZSkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZElubGluZUJsb2NrIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdGVtZW50czogdGhpcy5zdGF0ZW1lbnRzLFxuICAgICAgcGFyYW1ldGVyczogdGhpcy50YWJsZS5zbG90cyxcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZUJsb2NrIGV4dGVuZHMgQmxvY2sge1xuICBwdWJsaWMgdHlwZSA9ICd0ZW1wbGF0ZSc7XG4gIHB1YmxpYyB5aWVsZHMgPSBuZXcgRGljdFNldDxzdHJpbmc+KCk7XG4gIHB1YmxpYyBuYW1lZCA9IG5ldyBEaWN0U2V0PHN0cmluZz4oKTtcbiAgcHVibGljIGJsb2NrczogU2VyaWFsaXplZElubGluZUJsb2NrW10gPSBbXTtcbiAgcHVibGljIGhhc0V2YWwgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN5bWJvbFRhYmxlOiBQcm9ncmFtU3ltYm9sVGFibGUpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVzaChzdGF0ZW1lbnQ6IFN0YXRlbWVudCkge1xuICAgIHRoaXMuc3RhdGVtZW50cy5wdXNoKHN0YXRlbWVudCk7XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZFRlbXBsYXRlQmxvY2sge1xuICAgIHJldHVybiB7XG4gICAgICBzeW1ib2xzOiB0aGlzLnN5bWJvbFRhYmxlLnN5bWJvbHMsXG4gICAgICBzdGF0ZW1lbnRzOiB0aGlzLnN0YXRlbWVudHMsXG4gICAgICBoYXNFdmFsOiB0aGlzLmhhc0V2YWwsXG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQ29tcG9uZW50QmxvY2sgZXh0ZW5kcyBCbG9jayB7XG4gIHB1YmxpYyBhdHRyaWJ1dGVzOiBTdGF0ZW1lbnRzLkF0dHJpYnV0ZVtdID0gW107XG4gIHB1YmxpYyBhcmd1bWVudHM6IFN0YXRlbWVudHMuQXJndW1lbnRbXSA9IFtdO1xuICBwcml2YXRlIGluUGFyYW1zID0gdHJ1ZTtcbiAgcHVibGljIHBvc2l0aW9uYWxzOiBudW1iZXJbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdGFnOiBzdHJpbmcsIHByaXZhdGUgdGFibGU6IEJsb2NrU3ltYm9sVGFibGUsIHByaXZhdGUgc2VsZkNsb3Npbmc6IGJvb2xlYW4pIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVzaChzdGF0ZW1lbnQ6IFN0YXRlbWVudCkge1xuICAgIGlmICh0aGlzLmluUGFyYW1zKSB7XG4gICAgICBpZiAoaXNGbHVzaEVsZW1lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmluUGFyYW1zID0gZmFsc2U7XG4gICAgICB9IGVsc2UgaWYgKGlzQXJndW1lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmFyZ3VtZW50cy5wdXNoKHN0YXRlbWVudCk7XG4gICAgICB9IGVsc2UgaWYgKGlzQXR0cmlidXRlKHN0YXRlbWVudCkpIHtcbiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLnB1c2goc3RhdGVtZW50KTtcbiAgICAgIH0gZWxzZSBpZiAoaXNBdHRyU3BsYXQoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZXMucHVzaChzdGF0ZW1lbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21waWxlIEVycm9yOiBvbmx5IHBhcmFtZXRlcnMgYWxsb3dlZCBiZWZvcmUgZmx1c2gtZWxlbWVudCcpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0YXRlbWVudHMucHVzaChzdGF0ZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHRvSlNPTigpOiBbc3RyaW5nLCBTdGF0ZW1lbnRzLkF0dHJpYnV0ZVtdLCBDb3JlLkhhc2gsIE9wdGlvbjxTZXJpYWxpemVkSW5saW5lQmxvY2s+XSB7XG4gICAgbGV0IGFyZ3MgPSB0aGlzLmFyZ3VtZW50cztcbiAgICBsZXQga2V5cyA9IGFyZ3MubWFwKGFyZyA9PiBhcmdbMV0pO1xuICAgIGxldCB2YWx1ZXMgPSBhcmdzLm1hcChhcmcgPT4gYXJnWzJdKTtcbiAgICBsZXQgYmxvY2sgPSB0aGlzLnNlbGZDbG9zaW5nXG4gICAgICA/IG51bGxcbiAgICAgIDoge1xuICAgICAgICAgIHN0YXRlbWVudHM6IHRoaXMuc3RhdGVtZW50cyxcbiAgICAgICAgICBwYXJhbWV0ZXJzOiB0aGlzLnRhYmxlLnNsb3RzLFxuICAgICAgICB9O1xuXG4gICAgcmV0dXJuIFt0aGlzLnRhZywgdGhpcy5hdHRyaWJ1dGVzLCBba2V5cywgdmFsdWVzXSwgYmxvY2tdO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZSB7XG4gIHB1YmxpYyBibG9jazogVGVtcGxhdGVCbG9jaztcblxuICBjb25zdHJ1Y3RvcihzeW1ib2xzOiBQcm9ncmFtU3ltYm9sVGFibGUpIHtcbiAgICB0aGlzLmJsb2NrID0gbmV3IFRlbXBsYXRlQmxvY2soc3ltYm9scyk7XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZFRlbXBsYXRlQmxvY2sge1xuICAgIHJldHVybiB0aGlzLmJsb2NrLnRvSlNPTigpO1xuICB9XG59XG5cbmV4cG9ydCB0eXBlIEluVmFyaWFibGUgPSBudW1iZXI7XG5leHBvcnQgdHlwZSBJbk9wPEsgZXh0ZW5kcyBrZXlvZiBDb21waWxlck9wczxJblZhcmlhYmxlPiA9IE9wTmFtZT4gPSBPcDxcbiAgSW5WYXJpYWJsZSxcbiAgQ29tcGlsZXJPcHM8SW5WYXJpYWJsZT4sXG4gIEtcbj47XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEphdmFTY3JpcHRDb21waWxlclxuICBpbXBsZW1lbnRzIFByb2Nlc3NvcjxDb21waWxlck9wczxudW1iZXI+LCB2b2lkLCBDb21waWxlck9wczx2b2lkPj4ge1xuICBzdGF0aWMgcHJvY2VzcyhvcGNvZGVzOiBJbk9wW10sIHN5bWJvbHM6IFByb2dyYW1TeW1ib2xUYWJsZSwgb3B0aW9ucz86IENvbXBpbGVPcHRpb25zKTogVGVtcGxhdGUge1xuICAgIGxldCBjb21waWxlciA9IG5ldyBKYXZhU2NyaXB0Q29tcGlsZXIob3Bjb2Rlcywgc3ltYm9scywgb3B0aW9ucyk7XG4gICAgcmV0dXJuIGNvbXBpbGVyLnByb2Nlc3MoKTtcbiAgfVxuXG4gIHByaXZhdGUgdGVtcGxhdGU6IFRlbXBsYXRlO1xuICBwcml2YXRlIGJsb2NrcyA9IG5ldyBTdGFjazxCbG9jaz4oKTtcbiAgcHJpdmF0ZSBvcGNvZGVzOiBJbk9wW107XG4gIHByaXZhdGUgdmFsdWVzOiBTdGFja1ZhbHVlW10gPSBbXTtcbiAgcHJpdmF0ZSBvcHRpb25zOiBDb21waWxlT3B0aW9ucyB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihvcGNvZGVzOiBJbk9wW10sIHN5bWJvbHM6IFByb2dyYW1TeW1ib2xUYWJsZSwgb3B0aW9ucz86IENvbXBpbGVPcHRpb25zKSB7XG4gICAgdGhpcy5vcGNvZGVzID0gb3Bjb2RlcztcbiAgICB0aGlzLnRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHN5bWJvbHMpO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICBnZXQgY3VycmVudEJsb2NrKCk6IEJsb2NrIHtcbiAgICByZXR1cm4gZXhwZWN0KHRoaXMuYmxvY2tzLmN1cnJlbnQsICdFeHBlY3RlZCBhIGJsb2NrIG9uIHRoZSBzdGFjaycpO1xuICB9XG5cbiAgcHJvY2VzcygpOiBUZW1wbGF0ZSB7XG4gICAgdGhpcy5vcGNvZGVzLmZvckVhY2gob3AgPT4ge1xuICAgICAgbGV0IG9wY29kZSA9IG9wWzBdO1xuICAgICAgbGV0IGFyZyA9IG9wWzFdO1xuXG4gICAgICBpZiAoIXRoaXNbb3Bjb2RlXSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVuaW1wbGVtZW50ZWQgJHtvcGNvZGV9IG9uIEphdmFTY3JpcHRDb21waWxlcmApO1xuICAgICAgfVxuICAgICAgKHRoaXNbb3Bjb2RlXSBhcyBhbnkpKGFyZyk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZTtcbiAgfVxuXG4gIC8vLyBOZXN0aW5nXG5cbiAgc3RhcnRCbG9jayhwcm9ncmFtOiBBU1QuUHJvZ3JhbSkge1xuICAgIGxldCBibG9jazogQmxvY2sgPSBuZXcgSW5saW5lQmxvY2socHJvZ3JhbVsnc3ltYm9scyddKTtcbiAgICB0aGlzLmJsb2Nrcy5wdXNoKGJsb2NrKTtcbiAgfVxuXG4gIGVuZEJsb2NrKCkge1xuICAgIGxldCB7IHRlbXBsYXRlLCBibG9ja3MgfSA9IHRoaXM7XG4gICAgbGV0IGJsb2NrID0gYmxvY2tzLnBvcCgpIGFzIElubGluZUJsb2NrO1xuICAgIHRlbXBsYXRlLmJsb2NrLmJsb2Nrcy5wdXNoKGJsb2NrLnRvSlNPTigpKTtcbiAgfVxuXG4gIHN0YXJ0UHJvZ3JhbSgpIHtcbiAgICB0aGlzLmJsb2Nrcy5wdXNoKHRoaXMudGVtcGxhdGUuYmxvY2spO1xuICB9XG5cbiAgZW5kUHJvZ3JhbSgpIHt9XG5cbiAgLy8vIFN0YXRlbWVudHNcblxuICB0ZXh0KGNvbnRlbnQ6IHN0cmluZykge1xuICAgIHRoaXMucHVzaChbT3BzLlRleHQsIGNvbnRlbnRdKTtcbiAgfVxuXG4gIGFwcGVuZCh0cnVzdGVkOiBib29sZWFuKSB7XG4gICAgdGhpcy5wdXNoKFtPcHMuQXBwZW5kLCB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCksIHRydXN0ZWRdKTtcbiAgfVxuXG4gIGNvbW1lbnQodmFsdWU6IHN0cmluZykge1xuICAgIHRoaXMucHVzaChbT3BzLkNvbW1lbnQsIHZhbHVlXSk7XG4gIH1cblxuICBtb2RpZmllcihuYW1lOiBzdHJpbmcpIHtcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCk7XG4gICAgbGV0IGhhc2ggPSB0aGlzLnBvcFZhbHVlPEhhc2g+KCk7XG5cbiAgICB0aGlzLnB1c2goW09wcy5Nb2RpZmllciwgbmFtZSwgcGFyYW1zLCBoYXNoXSk7XG4gIH1cblxuICBibG9jayhbbmFtZSwgdGVtcGxhdGUsIGludmVyc2VdOiBbc3RyaW5nLCBudW1iZXIsIE9wdGlvbjxudW1iZXI+XSkge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKTtcbiAgICBsZXQgaGFzaCA9IHRoaXMucG9wVmFsdWU8SGFzaD4oKTtcblxuICAgIGxldCBibG9ja3MgPSB0aGlzLnRlbXBsYXRlLmJsb2NrLmJsb2NrcztcbiAgICBhc3NlcnQoXG4gICAgICB0eXBlb2YgdGVtcGxhdGUgIT09ICdudW1iZXInIHx8IGJsb2Nrc1t0ZW1wbGF0ZV0gIT09IG51bGwsXG4gICAgICAnbWlzc2luZyBibG9jayBpbiB0aGUgY29tcGlsZXInXG4gICAgKTtcbiAgICBhc3NlcnQoXG4gICAgICB0eXBlb2YgaW52ZXJzZSAhPT0gJ251bWJlcicgfHwgYmxvY2tzW2ludmVyc2VdICE9PSBudWxsLFxuICAgICAgJ21pc3NpbmcgYmxvY2sgaW4gdGhlIGNvbXBpbGVyJ1xuICAgICk7XG5cbiAgICB0aGlzLnB1c2goW09wcy5CbG9jaywgbmFtZSwgcGFyYW1zLCBoYXNoLCBibG9ja3NbdGVtcGxhdGVdLCBibG9ja3NbaW52ZXJzZSFdXSk7XG4gIH1cblxuICBvcGVuQ29tcG9uZW50KGVsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGxldCB0YWcgPVxuICAgICAgdGhpcy5vcHRpb25zICYmIHRoaXMub3B0aW9ucy5jdXN0b21pemVDb21wb25lbnROYW1lXG4gICAgICAgID8gdGhpcy5vcHRpb25zLmN1c3RvbWl6ZUNvbXBvbmVudE5hbWUoZWxlbWVudC50YWcpXG4gICAgICAgIDogZWxlbWVudC50YWc7XG4gICAgbGV0IGNvbXBvbmVudCA9IG5ldyBDb21wb25lbnRCbG9jayh0YWcsIGVsZW1lbnRbJ3N5bWJvbHMnXSwgZWxlbWVudC5zZWxmQ2xvc2luZyk7XG4gICAgdGhpcy5ibG9ja3MucHVzaChjb21wb25lbnQpO1xuICB9XG5cbiAgb3BlblNwbGF0dGVkRWxlbWVudChlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICBsZXQgdGFnID0gZWxlbWVudC50YWc7XG5cbiAgICBpZiAoZWxlbWVudC5ibG9ja1BhcmFtcy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDb21waWxlIEVycm9yOiA8JHtlbGVtZW50LnRhZ30+IGlzIG5vdCBhIGNvbXBvbmVudCBhbmQgZG9lc24ndCBzdXBwb3J0IGJsb2NrIHBhcmFtZXRlcnNgXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1c2goW09wcy5PcGVuU3BsYXR0ZWRFbGVtZW50LCB0YWddKTtcbiAgICB9XG4gIH1cblxuICBvcGVuRWxlbWVudChlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICBsZXQgdGFnID0gZWxlbWVudC50YWc7XG5cbiAgICBpZiAoZWxlbWVudC5ibG9ja1BhcmFtcy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDb21waWxlIEVycm9yOiA8JHtlbGVtZW50LnRhZ30+IGlzIG5vdCBhIGNvbXBvbmVudCBhbmQgZG9lc24ndCBzdXBwb3J0IGJsb2NrIHBhcmFtZXRlcnNgXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1c2goW09wcy5PcGVuRWxlbWVudCwgdGFnXSk7XG4gICAgfVxuICB9XG5cbiAgZmx1c2hFbGVtZW50KCkge1xuICAgIHRoaXMucHVzaChbT3BzLkZsdXNoRWxlbWVudF0pO1xuICB9XG5cbiAgY2xvc2VDb21wb25lbnQoX2VsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGlmIChfZWxlbWVudC5tb2RpZmllcnMubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21waWxlIEVycm9yOiBFbGVtZW50IG1vZGlmaWVycyBhcmUgbm90IGFsbG93ZWQgaW4gY29tcG9uZW50cycpO1xuICAgIH1cbiAgICBsZXQgW3RhZywgYXR0cnMsIGFyZ3MsIGJsb2NrXSA9IHRoaXMuZW5kQ29tcG9uZW50KCk7XG5cbiAgICB0aGlzLnB1c2goW09wcy5Db21wb25lbnQsIHRhZywgYXR0cnMsIGFyZ3MsIGJsb2NrXSk7XG4gIH1cblxuICBjbG9zZUR5bmFtaWNDb21wb25lbnQoX2VsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGxldCBbLCBhdHRycywgYXJncywgYmxvY2tdID0gdGhpcy5lbmRDb21wb25lbnQoKTtcblxuICAgIHRoaXMucHVzaChbT3BzLkR5bmFtaWNDb21wb25lbnQsIHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKSwgYXR0cnMsIGFyZ3MsIGJsb2NrXSk7XG4gIH1cblxuICBjbG9zZUVsZW1lbnQoX2VsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMucHVzaChbT3BzLkNsb3NlRWxlbWVudF0pO1xuICB9XG5cbiAgc3RhdGljQXR0cihbbmFtZSwgbmFtZXNwYWNlXTogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7XG4gICAgbGV0IHZhbHVlID0gdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpO1xuICAgIHRoaXMucHVzaChbT3BzLlN0YXRpY0F0dHIsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2VdKTtcbiAgfVxuXG4gIGR5bmFtaWNBdHRyKFtuYW1lLCBuYW1lc3BhY2VdOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuRHluYW1pY0F0dHIsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2VdKTtcbiAgfVxuXG4gIHRydXN0aW5nQXR0cihbbmFtZSwgbmFtZXNwYWNlXTogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7XG4gICAgbGV0IHZhbHVlID0gdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpO1xuICAgIHRoaXMucHVzaChbT3BzLlRydXN0aW5nQXR0ciwgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZSFdKTtcbiAgfVxuXG4gIHN0YXRpY0FyZyhuYW1lOiBzdHIpIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuU3RhdGljQXJnLCBuYW1lLCB2YWx1ZV0pO1xuICB9XG5cbiAgZHluYW1pY0FyZyhuYW1lOiBzdHIpIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuRHluYW1pY0FyZywgbmFtZSwgdmFsdWVdKTtcbiAgfVxuXG4gIHlpZWxkKHRvOiBudW1iZXIpIHtcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuWWllbGQsIHRvLCBwYXJhbXNdKTtcbiAgfVxuXG4gIGF0dHJTcGxhdCh0bzogT3B0aW9uPG51bWJlcj4pIHtcbiAgICB0aGlzLnB1c2goW09wcy5BdHRyU3BsYXQsIHRvIV0pO1xuICB9XG5cbiAgZGVidWdnZXIoZXZhbEluZm86IE9wdGlvbjxDb3JlLkV2YWxJbmZvPikge1xuICAgIHRoaXMucHVzaChbT3BzLkRlYnVnZ2VyLCBldmFsSW5mbyFdKTtcbiAgICB0aGlzLnRlbXBsYXRlLmJsb2NrLmhhc0V2YWwgPSB0cnVlO1xuICB9XG5cbiAgaGFzQmxvY2sobmFtZTogbnVtYmVyKSB7XG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuSGFzQmxvY2s+KFtPcHMuSGFzQmxvY2ssIG5hbWVdKTtcbiAgfVxuXG4gIGhhc0Jsb2NrUGFyYW1zKG5hbWU6IG51bWJlcikge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkhhc0Jsb2NrUGFyYW1zPihbT3BzLkhhc0Jsb2NrUGFyYW1zLCBuYW1lXSk7XG4gIH1cblxuICBwYXJ0aWFsKGV2YWxJbmZvOiBPcHRpb248Q29yZS5FdmFsSW5mbz4pIHtcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuUGFydGlhbCwgcGFyYW1zWzBdLCBldmFsSW5mbyFdKTtcbiAgICB0aGlzLnRlbXBsYXRlLmJsb2NrLmhhc0V2YWwgPSB0cnVlO1xuICB9XG5cbiAgLy8vIEV4cHJlc3Npb25zXG5cbiAgbGl0ZXJhbCh2YWx1ZTogRXhwcmVzc2lvbnMuVmFsdWUgfCB1bmRlZmluZWQpIHtcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuVW5kZWZpbmVkPihbT3BzLlVuZGVmaW5lZF0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5WYWx1ZT4odmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHVua25vd24obmFtZTogc3RyaW5nKSB7XG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuVW5rbm93bj4oW09wcy5Vbmtub3duLCBuYW1lXSk7XG4gIH1cblxuICBnZXQoW2hlYWQsIHBhdGhdOiBbbnVtYmVyLCBzdHJpbmdbXV0pIHtcbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5HZXQ+KFtPcHMuR2V0LCBoZWFkLCBwYXRoXSk7XG4gIH1cblxuICBtYXliZUxvY2FsKHBhdGg6IHN0cmluZ1tdKSB7XG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuTWF5YmVMb2NhbD4oW09wcy5NYXliZUxvY2FsLCBwYXRoXSk7XG4gIH1cblxuICBjb25jYXQoKSB7XG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuQ29uY2F0PihbT3BzLkNvbmNhdCwgdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCldKTtcbiAgfVxuXG4gIGhlbHBlcihuYW1lOiBzdHJpbmcpIHtcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCk7XG4gICAgbGV0IGhhc2ggPSB0aGlzLnBvcFZhbHVlPEhhc2g+KCk7XG5cbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5IZWxwZXI+KFtPcHMuSGVscGVyLCBuYW1lLCBwYXJhbXMsIGhhc2hdKTtcbiAgfVxuXG4gIC8vLyBTdGFjayBNYW5hZ2VtZW50IE9wY29kZXNcblxuICBwcmVwYXJlQXJyYXkoc2l6ZTogbnVtYmVyKSB7XG4gICAgbGV0IHZhbHVlczogRXhwcmVzc2lvbltdID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykge1xuICAgICAgdmFsdWVzLnB1c2godGhpcy5wb3BWYWx1ZSgpIGFzIEV4cHJlc3Npb24pO1xuICAgIH1cblxuICAgIHRoaXMucHVzaFZhbHVlPFBhcmFtcz4odmFsdWVzKTtcbiAgfVxuXG4gIHByZXBhcmVPYmplY3Qoc2l6ZTogbnVtYmVyKSB7XG4gICAgYXNzZXJ0KFxuICAgICAgdGhpcy52YWx1ZXMubGVuZ3RoID49IHNpemUsXG4gICAgICBgRXhwZWN0ZWQgJHtzaXplfSB2YWx1ZXMgb24gdGhlIHN0YWNrLCBmb3VuZCAke3RoaXMudmFsdWVzLmxlbmd0aH1gXG4gICAgKTtcblxuICAgIGxldCBrZXlzOiBzdHJpbmdbXSA9IG5ldyBBcnJheShzaXplKTtcbiAgICBsZXQgdmFsdWVzOiBFeHByZXNzaW9uW10gPSBuZXcgQXJyYXkoc2l6ZSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykge1xuICAgICAga2V5c1tpXSA9IHRoaXMucG9wVmFsdWU8c3RyPigpO1xuICAgICAgdmFsdWVzW2ldID0gdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpO1xuICAgIH1cblxuICAgIHRoaXMucHVzaFZhbHVlPEhhc2g+KFtrZXlzLCB2YWx1ZXNdKTtcbiAgfVxuXG4gIC8vLyBVdGlsaXRpZXNcblxuICBlbmRDb21wb25lbnQoKTogW3N0cmluZywgU3RhdGVtZW50cy5BdHRyaWJ1dGVbXSwgQ29yZS5IYXNoLCBPcHRpb248U2VyaWFsaXplZElubGluZUJsb2NrPl0ge1xuICAgIGxldCBjb21wb25lbnQgPSB0aGlzLmJsb2Nrcy5wb3AoKTtcbiAgICBhc3NlcnQoXG4gICAgICBjb21wb25lbnQgaW5zdGFuY2VvZiBDb21wb25lbnRCbG9jayxcbiAgICAgICdDb21waWxlciBidWc6IGVuZENvbXBvbmVudCgpIHNob3VsZCBlbmQgYSBjb21wb25lbnQnXG4gICAgKTtcblxuICAgIHJldHVybiAoY29tcG9uZW50IGFzIENvbXBvbmVudEJsb2NrKS50b0pTT04oKTtcbiAgfVxuXG4gIHB1c2goYXJnczogU3RhdGVtZW50KSB7XG4gICAgd2hpbGUgKGFyZ3NbYXJncy5sZW5ndGggLSAxXSA9PT0gbnVsbCkge1xuICAgICAgYXJncy5wb3AoKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRCbG9jay5wdXNoKGFyZ3MpO1xuICB9XG5cbiAgcHVzaFZhbHVlPFMgZXh0ZW5kcyBFeHByZXNzaW9uIHwgUGFyYW1zIHwgSGFzaD4odmFsOiBTKSB7XG4gICAgdGhpcy52YWx1ZXMucHVzaCh2YWwpO1xuICB9XG5cbiAgcG9wVmFsdWU8VCBleHRlbmRzIFN0YWNrVmFsdWU+KCk6IFQge1xuICAgIGFzc2VydCh0aGlzLnZhbHVlcy5sZW5ndGgsICdObyBleHByZXNzaW9uIGZvdW5kIG9uIHN0YWNrJyk7XG4gICAgcmV0dXJuIHRoaXMudmFsdWVzLnBvcCgpIGFzIFQ7XG4gIH1cbn1cbiJdfQ==