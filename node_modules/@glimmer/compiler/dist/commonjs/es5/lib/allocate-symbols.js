"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.SymbolAllocator = undefined;

var _util = require("@glimmer/util");

var _createClass = function () {
    function defineProperties(target, props) {
        for (var i = 0; i < props.length; i++) {
            var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);
        }
    }return function (Constructor, protoProps, staticProps) {
        if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;
    };
}();

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

var SymbolAllocator = exports.SymbolAllocator = function () {
    function SymbolAllocator(ops) {
        _classCallCheck(this, SymbolAllocator);

        this.ops = ops;
        this.symbolStack = new _util.Stack();
    }

    SymbolAllocator.prototype.process = function process() {
        var out = [];
        var ops = this.ops;

        for (var i = 0; i < ops.length; i++) {
            var op = ops[i];
            var result = this.dispatch(op);
            if (result === undefined) {
                out.push(op);
            } else {
                out.push(result);
            }
        }
        return out;
    };

    SymbolAllocator.prototype.dispatch = function dispatch(op) {
        var name = op[0];
        var operand = op[1];
        return this[name](operand);
    };

    SymbolAllocator.prototype.startProgram = function startProgram(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.endProgram = function endProgram(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.startBlock = function startBlock(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.endBlock = function endBlock(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.flushElement = function flushElement(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.closeElement = function closeElement(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.closeComponent = function closeComponent(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.closeDynamicComponent = function closeDynamicComponent(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.attrSplat = function attrSplat(_op) {
        return ['attrSplat', this.symbols.allocateBlock('attrs')];
    };

    SymbolAllocator.prototype.get = function get(op) {
        var name = op[0],
            rest = op[1];

        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            var head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            var _head = this.symbols.allocateNamed(name);
            return ['get', [_head, rest]];
        } else {
            return ['maybeLocal', [name].concat(rest)];
        }
    };

    SymbolAllocator.prototype.maybeGet = function maybeGet(op) {
        var name = op[0],
            rest = op[1];

        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            var head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            var _head2 = this.symbols.allocateNamed(name);
            return ['get', [_head2, rest]];
        } else if (rest.length === 0) {
            return ['unknown', name];
        } else {
            return ['maybeLocal', [name].concat(rest)];
        }
    };

    SymbolAllocator.prototype.yield = function _yield(op) {
        if (op === 0) {
            throw new Error('Cannot yield to this');
        }
        return ['yield', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.debugger = function _debugger(_op) {
        return ['debugger', this.symbols.getEvalInfo()];
    };

    SymbolAllocator.prototype.hasBlock = function hasBlock(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlock this');
        }
        return ['hasBlock', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.hasBlockParams = function hasBlockParams(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlockParams this');
        }
        return ['hasBlockParams', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.partial = function partial(_op) {
        return ['partial', this.symbols.getEvalInfo()];
    };

    SymbolAllocator.prototype.text = function text(_op) {};

    SymbolAllocator.prototype.comment = function comment(_op) {};

    SymbolAllocator.prototype.openComponent = function openComponent(_op) {};

    SymbolAllocator.prototype.openElement = function openElement(_op) {};

    SymbolAllocator.prototype.openSplattedElement = function openSplattedElement(_op) {};

    SymbolAllocator.prototype.staticArg = function staticArg(_op) {};

    SymbolAllocator.prototype.dynamicArg = function dynamicArg(_op) {};

    SymbolAllocator.prototype.staticAttr = function staticAttr(_op) {};

    SymbolAllocator.prototype.trustingAttr = function trustingAttr(_op) {};

    SymbolAllocator.prototype.dynamicAttr = function dynamicAttr(_op) {};

    SymbolAllocator.prototype.modifier = function modifier(_op) {};

    SymbolAllocator.prototype.append = function append(_op) {};

    SymbolAllocator.prototype.block = function block(_op) {};

    SymbolAllocator.prototype.literal = function literal(_op) {};

    SymbolAllocator.prototype.helper = function helper(_op) {};

    SymbolAllocator.prototype.unknown = function unknown(_op) {};

    SymbolAllocator.prototype.maybeLocal = function maybeLocal(_op) {};

    SymbolAllocator.prototype.prepareArray = function prepareArray(_op) {};

    SymbolAllocator.prototype.prepareObject = function prepareObject(_op) {};

    SymbolAllocator.prototype.concat = function concat(_op) {};

    _createClass(SymbolAllocator, [{
        key: 'symbols',
        get: function get() {
            return this.symbolStack.current;
        }
    }]);

    return SymbolAllocator;
}();
function isLocal(name, symbols) {
    return symbols && symbols.has(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsb2NhdGUtc3ltYm9scy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9hbGxvY2F0ZS1zeW1ib2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFHQSxBQUFPLEFBQUUsQUFBSyxBQUFFLEFBQU0sQUFBRSxBQUFNLEFBQWUsQUFBQyxBQWlCOUMsQUFBTTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBSUo7NkJBQW9CLEFBQWdCLEtBQWhCOzs7YUFBRyxNQUZmLEFBRVksQUFBRyxBQUFhO2FBRmpCLGNBQUcsQUFBSSxBQUFLLEFBQWUsQUFBQyxBQUVSLEFBQUMsQUFFeEMsQUFBTzs7OztZQUNELEFBQUcsTUFBWSxBQUFFLEFBQUMsQUFDdEIsQUFBSSxBQURKO1lBQ00sQUFBRyxBQUFFLE1BQUcsQUFBSSxBQUFDLEFBRW5COzthQUFLLElBQUksQUFBQyxJQUFHLEFBQUMsR0FBRSxBQUFDLElBQUcsQUFBRyxJQUFDLEFBQU0sUUFBRSxBQUFDLEFBQUUsS0FBRSxBQUNuQztnQkFBSSxBQUFFLEtBQUcsQUFBRyxJQUFDLEFBQUMsQUFBQyxBQUFDLEFBQ2hCO2dCQUFJLEFBQU0sU0FBRyxBQUFJLEtBQUMsQUFBUSxTQUFDLEFBQUUsQUFBQyxBQUFDLEFBRS9CO2dCQUFJLEFBQU0sV0FBSyxBQUFTLFdBQUUsQUFDeEIsQUFBRztvQkFBQyxBQUFJLEtBQUMsQUFBVyxBQUFDLEFBQUMsQUFDdkI7bUJBQU0sQUFDTCxBQUFHO29CQUFDLEFBQUksS0FBQyxBQUFhLEFBQUMsQUFBQyxBQUN6QixBQUNGO0FBRUQ7O2VBQU8sQUFBRyxBQUFDLEFBQ2IsQUFBQyxBQUVELEFBQVE7OzsyREFBaUIsQUFBSyxJQUM1QjtZQUFJLEFBQUksT0FBRyxBQUFFLEdBQUMsQUFBQyxBQUFDLEFBQUMsQUFDakI7WUFBSSxBQUFPLFVBQUcsQUFBRSxHQUFDLEFBQUMsQUFBQyxBQUFDLEFBRXBCO2VB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VyxLQUFHLEFBQUMsQUFDN0IsQUFBTTs7dURBQUMsQUFBUyxLQUFHLEFBQUMsQUFDckI7Ozs7NEJBaklHLEFBQU8sQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBVyxZQUFDLEFBQU8sQUFBRSxBQUFzQyxBQUFDLEFBQUMsQUFDbEYsQUFBQyxBQUVELEFBQVk7Ozs7OztBQWdJZCxpQkFBaUIsQUFBWSxNQUFFLEFBQW9CLFNBQ2pEO1dBQU8sQUFBTyxXQUFJLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBSSxBQUFDLEFBQUMsQUFDdEMsQUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBpbGVyT3BzLCBQcm9jZXNzb3IsIE9wLCBPcE5hbWUsIFRlbXBsYXRlQ29tcGlsZXJPcHMsIFBhdGhIZWFkIH0gZnJvbSAnLi9jb21waWxlci1vcHMnO1xuaW1wb3J0IHsgQVNUIH0gZnJvbSAnQGdsaW1tZXIvc3ludGF4JztcbmltcG9ydCB7IE9wdGlvbiwgT3BhcXVlIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBTdGFjaywgZXhwZWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBTeW1ib2xUYWJsZSB9IGZyb20gJy4vdGVtcGxhdGUtdmlzaXRvcic7XG5cbmV4cG9ydCB0eXBlIEluVmFyaWFibGUgPSBQYXRoSGVhZDtcbmV4cG9ydCB0eXBlIE91dFZhcmlhYmxlID0gbnVtYmVyO1xuXG5leHBvcnQgdHlwZSBPdXRPcDxLIGV4dGVuZHMga2V5b2YgQ29tcGlsZXJPcHM8T3V0VmFyaWFibGU+ID0gT3BOYW1lPiA9IE9wPFxuICBPdXRWYXJpYWJsZSxcbiAgQ29tcGlsZXJPcHM8T3V0VmFyaWFibGU+LFxuICBLXG4+O1xuZXhwb3J0IHR5cGUgSW5PcDxLIGV4dGVuZHMga2V5b2YgVGVtcGxhdGVDb21waWxlck9wcyA9IGtleW9mIFRlbXBsYXRlQ29tcGlsZXJPcHM+ID0gT3A8XG4gIFBhdGhIZWFkLFxuICBUZW1wbGF0ZUNvbXBpbGVyT3BzLFxuICBLXG4+O1xuXG5leHBvcnQgY2xhc3MgU3ltYm9sQWxsb2NhdG9yXG4gIGltcGxlbWVudHMgUHJvY2Vzc29yPENvbXBpbGVyT3BzPEluVmFyaWFibGU+LCBPdXRWYXJpYWJsZSwgQ29tcGlsZXJPcHM8T3V0VmFyaWFibGU+PiB7XG4gIHByaXZhdGUgc3ltYm9sU3RhY2sgPSBuZXcgU3RhY2s8U3ltYm9sVGFibGU+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvcHM6IEFycmF5PEluT3A+KSB7fVxuXG4gIHByb2Nlc3MoKTogT3V0T3BbXSB7XG4gICAgbGV0IG91dDogT3V0T3BbXSA9IFtdO1xuICAgIGxldCB7IG9wcyB9ID0gdGhpcztcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3BzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgb3AgPSBvcHNbaV07XG4gICAgICBsZXQgcmVzdWx0ID0gdGhpcy5kaXNwYXRjaChvcCk7XG5cbiAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBvdXQucHVzaChvcCBhcyBPdXRPcCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXQucHVzaChyZXN1bHQgYXMgYW55KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgZGlzcGF0Y2g8TyBleHRlbmRzIEluT3A+KG9wOiBPKTogT3BhcXVlIHtcbiAgICBsZXQgbmFtZSA9IG9wWzBdO1xuICAgIGxldCBvcGVyYW5kID0gb3BbMV07XG5cbiAgICByZXR1cm4gKHRoaXNbbmFtZV0gYXMgYW55KShvcGVyYW5kKTtcbiAgfVxuXG4gIGdldCBzeW1ib2xzKCk6IFN5bWJvbFRhYmxlIHtcbiAgICByZXR1cm4gZXhwZWN0KHRoaXMuc3ltYm9sU3RhY2suY3VycmVudCwgJ0V4cGVjdGVkIGEgc3ltYm9sIHRhYmxlIG9uIHRoZSBzdGFjaycpO1xuICB9XG5cbiAgc3RhcnRQcm9ncmFtKG9wOiBBU1QuUHJvZ3JhbSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucHVzaChvcFsnc3ltYm9scyddKTtcbiAgfVxuXG4gIGVuZFByb2dyYW0oX29wOiBudWxsKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIHN0YXJ0QmxvY2sob3A6IEFTVC5Qcm9ncmFtKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wdXNoKG9wWydzeW1ib2xzJ10pO1xuICB9XG5cbiAgZW5kQmxvY2soX29wOiBudWxsKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIGZsdXNoRWxlbWVudChvcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wdXNoKG9wWydzeW1ib2xzJ10pO1xuICB9XG5cbiAgY2xvc2VFbGVtZW50KF9vcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIGNsb3NlQ29tcG9uZW50KF9vcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIGNsb3NlRHluYW1pY0NvbXBvbmVudChfb3A6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBhdHRyU3BsYXQoX29wOiBPcHRpb248SW5WYXJpYWJsZT4pOiBPdXRPcDwnYXR0clNwbGF0Jz4ge1xuICAgIHJldHVybiBbJ2F0dHJTcGxhdCcsIHRoaXMuc3ltYm9scy5hbGxvY2F0ZUJsb2NrKCdhdHRycycpXTtcbiAgfVxuXG4gIGdldChvcDogW0luVmFyaWFibGUsIHN0cmluZ1tdXSk6IE91dE9wPCdnZXQnIHwgJ21heWJlTG9jYWwnPiB7XG4gICAgbGV0IFtuYW1lLCByZXN0XSA9IG9wO1xuXG4gICAgaWYgKG5hbWUgPT09IDApIHtcbiAgICAgIHJldHVybiBbJ2dldCcsIFswLCByZXN0XV07XG4gICAgfVxuXG4gICAgaWYgKGlzTG9jYWwobmFtZSwgdGhpcy5zeW1ib2xzKSkge1xuICAgICAgbGV0IGhlYWQgPSB0aGlzLnN5bWJvbHMuZ2V0KG5hbWUpO1xuICAgICAgcmV0dXJuIFsnZ2V0JywgW2hlYWQsIHJlc3RdXTtcbiAgICB9IGVsc2UgaWYgKG5hbWVbMF0gPT09ICdAJykge1xuICAgICAgbGV0IGhlYWQgPSB0aGlzLnN5bWJvbHMuYWxsb2NhdGVOYW1lZChuYW1lKTtcbiAgICAgIHJldHVybiBbJ2dldCcsIFtoZWFkLCByZXN0XV07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbJ21heWJlTG9jYWwnLCBbbmFtZSwgLi4ucmVzdF1dO1xuICAgIH1cbiAgfVxuXG4gIG1heWJlR2V0KG9wOiBbSW5WYXJpYWJsZSwgc3RyaW5nW11dKTogT3V0T3A8J2dldCcgfCAndW5rbm93bicgfCAnbWF5YmVMb2NhbCc+IHtcbiAgICBsZXQgW25hbWUsIHJlc3RdID0gb3A7XG5cbiAgICBpZiAobmFtZSA9PT0gMCkge1xuICAgICAgcmV0dXJuIFsnZ2V0JywgWzAsIHJlc3RdXTtcbiAgICB9XG5cbiAgICBpZiAoaXNMb2NhbChuYW1lLCB0aGlzLnN5bWJvbHMpKSB7XG4gICAgICBsZXQgaGVhZCA9IHRoaXMuc3ltYm9scy5nZXQobmFtZSk7XG4gICAgICByZXR1cm4gWydnZXQnLCBbaGVhZCwgcmVzdF1dO1xuICAgIH0gZWxzZSBpZiAobmFtZVswXSA9PT0gJ0AnKSB7XG4gICAgICBsZXQgaGVhZCA9IHRoaXMuc3ltYm9scy5hbGxvY2F0ZU5hbWVkKG5hbWUpO1xuICAgICAgcmV0dXJuIFsnZ2V0JywgW2hlYWQsIHJlc3RdXTtcbiAgICB9IGVsc2UgaWYgKHJlc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gWyd1bmtub3duJywgbmFtZV07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbJ21heWJlTG9jYWwnLCBbbmFtZSwgLi4ucmVzdF1dO1xuICAgIH1cbiAgfVxuXG4gIHlpZWxkKG9wOiBJblZhcmlhYmxlKTogT3V0T3A8J3lpZWxkJz4ge1xuICAgIGlmIChvcCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgeWllbGQgdG8gdGhpcycpO1xuICAgIH1cblxuICAgIHJldHVybiBbJ3lpZWxkJywgdGhpcy5zeW1ib2xzLmFsbG9jYXRlQmxvY2sob3ApXTtcbiAgfVxuXG4gIGRlYnVnZ2VyKF9vcDogT3B0aW9uPEluVmFyaWFibGVbXT4pOiBPdXRPcDwnZGVidWdnZXInPiB7XG4gICAgcmV0dXJuIFsnZGVidWdnZXInLCB0aGlzLnN5bWJvbHMuZ2V0RXZhbEluZm8oKV07XG4gIH1cblxuICBoYXNCbG9jayhvcDogSW5WYXJpYWJsZSk6IE91dE9wPCdoYXNCbG9jayc+IHtcbiAgICBpZiAob3AgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGhhc0Jsb2NrIHRoaXMnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gWydoYXNCbG9jaycsIHRoaXMuc3ltYm9scy5hbGxvY2F0ZUJsb2NrKG9wKV07XG4gIH1cblxuICBoYXNCbG9ja1BhcmFtcyhvcDogSW5WYXJpYWJsZSk6IE91dE9wPCdoYXNCbG9ja1BhcmFtcyc+IHtcbiAgICBpZiAob3AgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGhhc0Jsb2NrUGFyYW1zIHRoaXMnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gWydoYXNCbG9ja1BhcmFtcycsIHRoaXMuc3ltYm9scy5hbGxvY2F0ZUJsb2NrKG9wKV07XG4gIH1cblxuICBwYXJ0aWFsKF9vcDogT3B0aW9uPEluVmFyaWFibGVbXT4pOiBPdXRPcDwncGFydGlhbCc+IHtcbiAgICByZXR1cm4gWydwYXJ0aWFsJywgdGhpcy5zeW1ib2xzLmdldEV2YWxJbmZvKCldO1xuICB9XG5cbiAgdGV4dChfb3A6IHN0cmluZykge31cbiAgY29tbWVudChfb3A6IHN0cmluZykge31cbiAgb3BlbkNvbXBvbmVudChfb3A6IEFTVC5FbGVtZW50Tm9kZSkge31cbiAgb3BlbkVsZW1lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHt9XG4gIG9wZW5TcGxhdHRlZEVsZW1lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHt9XG4gIHN0YXRpY0FyZyhfb3A6IHN0cmluZykge31cbiAgZHluYW1pY0FyZyhfb3A6IHN0cmluZykge31cbiAgc3RhdGljQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgdHJ1c3RpbmdBdHRyKF9vcDogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7fVxuICBkeW5hbWljQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgbW9kaWZpZXIoX29wOiBzdHJpbmcpIHt9XG4gIGFwcGVuZChfb3A6IGJvb2xlYW4pIHt9XG4gIGJsb2NrKF9vcDogW3N0cmluZywgbnVtYmVyLCBPcHRpb248bnVtYmVyPl0pIHt9XG4gIGxpdGVyYWwoX29wOiBzdHJpbmcgfCBib29sZWFuIHwgbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkge31cbiAgaGVscGVyKF9vcDogc3RyaW5nKSB7fVxuICB1bmtub3duKF9vcDogc3RyaW5nKSB7fVxuICBtYXliZUxvY2FsKF9vcDogc3RyaW5nW10pIHt9XG4gIHByZXBhcmVBcnJheShfb3A6IG51bWJlcikge31cbiAgcHJlcGFyZU9iamVjdChfb3A6IG51bWJlcikge31cbiAgY29uY2F0KF9vcDogbnVsbCkge31cbn1cblxuZnVuY3Rpb24gaXNMb2NhbChuYW1lOiBzdHJpbmcsIHN5bWJvbHM6IFN5bWJvbFRhYmxlKTogYm9vbGVhbiB7XG4gIHJldHVybiBzeW1ib2xzICYmIHN5bWJvbHMuaGFzKG5hbWUpO1xufVxuIl19