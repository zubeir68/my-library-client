function _defaults(obj, defaults) { var keys = Object.getOwnPropertyNames(defaults); for (var i = 0; i < keys.length; i++) { var key = keys[i]; var value = Object.getOwnPropertyDescriptor(defaults, key); if (value && value.configurable && obj[key] === undefined) { Object.defineProperty(obj, key, value); } } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : _defaults(subClass, superClass); }

import b, { SYNTHETIC } from '../builders';
import { appendChild, parseElementBlockParams } from '../utils';
import { HandlebarsNodeVisitors } from './handlebars-node-visitors';
import SyntaxError from '../errors/syntax-error';
import builders from '../builders';
import traverse from '../traversal/traverse';
import print from '../generation/print';
import Walker from '../traversal/walker';
import * as handlebars from 'handlebars';
import { assign } from '@glimmer/util';
export var voidMap = Object.create(null);
var voidTagNames = 'area base br col command embed hr img input keygen link meta param source track wbr';
voidTagNames.split(' ').forEach(function (tagName) {
    voidMap[tagName] = true;
});
export var TokenizerEventHandlers = function (_HandlebarsNodeVisito) {
    _inherits(TokenizerEventHandlers, _HandlebarsNodeVisito);

    function TokenizerEventHandlers() {
        _classCallCheck(this, TokenizerEventHandlers);

        var _this = _possibleConstructorReturn(this, _HandlebarsNodeVisito.apply(this, arguments));

        _this.tagOpenLine = 0;
        _this.tagOpenColumn = 0;
        return _this;
    }

    TokenizerEventHandlers.prototype.reset = function reset() {
        this.currentNode = null;
    };
    // Comment


    TokenizerEventHandlers.prototype.beginComment = function beginComment() {
        this.currentNode = b.comment('');
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tagOpenLine, this.tagOpenColumn),
            end: null
        };
    };

    TokenizerEventHandlers.prototype.appendToCommentData = function appendToCommentData(char) {
        this.currentComment.value += char;
    };

    TokenizerEventHandlers.prototype.finishComment = function finishComment() {
        this.currentComment.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentComment);
    };
    // Data


    TokenizerEventHandlers.prototype.beginData = function beginData() {
        this.currentNode = b.text();
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            end: null
        };
    };

    TokenizerEventHandlers.prototype.appendToData = function appendToData(char) {
        this.currentData.chars += char;
    };

    TokenizerEventHandlers.prototype.finishData = function finishData() {
        this.currentData.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentData);
    };
    // Tags - basic


    TokenizerEventHandlers.prototype.tagOpen = function tagOpen() {
        this.tagOpenLine = this.tokenizer.line;
        this.tagOpenColumn = this.tokenizer.column;
    };

    TokenizerEventHandlers.prototype.beginStartTag = function beginStartTag() {
        this.currentNode = {
            type: 'StartTag',
            name: '',
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    };

    TokenizerEventHandlers.prototype.beginEndTag = function beginEndTag() {
        this.currentNode = {
            type: 'EndTag',
            name: '',
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    };

    TokenizerEventHandlers.prototype.finishTag = function finishTag() {
        var _tokenizer = this.tokenizer,
            line = _tokenizer.line,
            column = _tokenizer.column;

        var tag = this.currentTag;
        tag.loc = b.loc(this.tagOpenLine, this.tagOpenColumn, line, column);
        if (tag.type === 'StartTag') {
            this.finishStartTag();
            if (voidMap[tag.name] || tag.selfClosing) {
                this.finishEndTag(true);
            }
        } else if (tag.type === 'EndTag') {
            this.finishEndTag(false);
        }
    };

    TokenizerEventHandlers.prototype.finishStartTag = function finishStartTag() {
        var _currentStartTag = this.currentStartTag,
            name = _currentStartTag.name,
            attributes = _currentStartTag.attributes,
            modifiers = _currentStartTag.modifiers,
            comments = _currentStartTag.comments,
            selfClosing = _currentStartTag.selfClosing;

        var loc = b.loc(this.tagOpenLine, this.tagOpenColumn);
        var element = b.element({ name: name, selfClosing: selfClosing }, attributes, modifiers, [], comments, [], loc);
        this.elementStack.push(element);
    };

    TokenizerEventHandlers.prototype.finishEndTag = function finishEndTag(isVoid) {
        var tag = this.currentTag;
        var element = this.elementStack.pop();
        var parent = this.currentElement();
        validateEndTag(tag, element, isVoid);
        element.loc.end.line = this.tokenizer.line;
        element.loc.end.column = this.tokenizer.column;
        parseElementBlockParams(element);
        appendChild(parent, element);
    };

    TokenizerEventHandlers.prototype.markTagAsSelfClosing = function markTagAsSelfClosing() {
        this.currentTag.selfClosing = true;
    };
    // Tags - name


    TokenizerEventHandlers.prototype.appendToTagName = function appendToTagName(char) {
        this.currentTag.name += char;
    };
    // Tags - attributes


    TokenizerEventHandlers.prototype.beginAttribute = function beginAttribute() {
        var tag = this.currentTag;
        if (tag.type === 'EndTag') {
            throw new SyntaxError('Invalid end tag: closing tag must not have attributes, ' + ('in `' + tag.name + '` (on line ' + this.tokenizer.line + ').'), tag.loc);
        }
        this.currentAttribute = {
            name: '',
            parts: [],
            isQuoted: false,
            isDynamic: false,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            valueStartLine: 0,
            valueStartColumn: 0
        };
    };

    TokenizerEventHandlers.prototype.appendToAttributeName = function appendToAttributeName(char) {
        this.currentAttr.name += char;
    };

    TokenizerEventHandlers.prototype.beginAttributeValue = function beginAttributeValue(isQuoted) {
        this.currentAttr.isQuoted = isQuoted;
        this.currentAttr.valueStartLine = this.tokenizer.line;
        this.currentAttr.valueStartColumn = this.tokenizer.column;
    };

    TokenizerEventHandlers.prototype.appendToAttributeValue = function appendToAttributeValue(char) {
        var parts = this.currentAttr.parts;
        var lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.type === 'TextNode') {
            lastPart.chars += char;
            // update end location for each added char
            lastPart.loc.end.line = this.tokenizer.line;
            lastPart.loc.end.column = this.tokenizer.column;
        } else {
            // initially assume the text node is a single char
            var loc = b.loc(this.tokenizer.line, this.tokenizer.column, this.tokenizer.line, this.tokenizer.column);
            // correct for `\n` as first char
            if (char === '\n') {
                loc.start.line -= 1;
                loc.start.column = lastPart ? lastPart.loc.end.column : this.currentAttr.valueStartColumn;
            }
            var text = b.text(char, loc);
            parts.push(text);
        }
    };

    TokenizerEventHandlers.prototype.finishAttributeValue = function finishAttributeValue() {
        var _currentAttr = this.currentAttr,
            name = _currentAttr.name,
            parts = _currentAttr.parts,
            isQuoted = _currentAttr.isQuoted,
            isDynamic = _currentAttr.isDynamic,
            valueStartLine = _currentAttr.valueStartLine,
            valueStartColumn = _currentAttr.valueStartColumn;

        var value = assembleAttributeValue(parts, isQuoted, isDynamic, this.tokenizer.line);
        value.loc = b.loc(valueStartLine, valueStartColumn, this.tokenizer.line, this.tokenizer.column);
        var loc = b.loc(this.currentAttr.start.line, this.currentAttr.start.column, this.tokenizer.line, this.tokenizer.column);
        var attribute = b.attr(name, value, loc);
        this.currentStartTag.attributes.push(attribute);
    };

    TokenizerEventHandlers.prototype.reportSyntaxError = function reportSyntaxError(message) {
        throw new SyntaxError('Syntax error at line ' + this.tokenizer.line + ' col ' + this.tokenizer.column + ': ' + message, b.loc(this.tokenizer.line, this.tokenizer.column));
    };

    return TokenizerEventHandlers;
}(HandlebarsNodeVisitors);
function assembleAttributeValue(parts, isQuoted, isDynamic, line) {
    if (isDynamic) {
        if (isQuoted) {
            return assembleConcatenatedValue(parts);
        } else {
            if (parts.length === 1 || parts.length === 2 && parts[1].type === 'TextNode' && parts[1].chars === '/') {
                return parts[0];
            } else {
                throw new SyntaxError('An unquoted attribute value must be a string or a mustache, ' + 'preceeded by whitespace or a \'=\' character, and ' + ('followed by whitespace, a \'>\' character, or \'/>\' (on line ' + line + ')'), b.loc(line, 0));
            }
        }
    } else {
        return parts.length > 0 ? parts[0] : b.text('');
    }
}
function assembleConcatenatedValue(parts) {
    for (var i = 0; i < parts.length; i++) {
        var part = parts[i];
        if (part.type !== 'MustacheStatement' && part.type !== 'TextNode') {
            throw new SyntaxError('Unsupported node in quoted attribute value: ' + part['type'], part.loc);
        }
    }
    return b.concat(parts);
}
function validateEndTag(tag, element, selfClosing) {
    var error = void 0;
    if (voidMap[tag.name] && !selfClosing) {
        // EngTag is also called by StartTag for void and self-closing tags (i.e.
        // <input> or <br />, so we need to check for that here. Otherwise, we would
        // throw an error for those cases.
        error = 'Invalid end tag ' + formatEndTagInfo(tag) + ' (void elements cannot have end tags).';
    } else if (element.tag === undefined) {
        error = 'Closing tag ' + formatEndTagInfo(tag) + ' without an open tag.';
    } else if (element.tag !== tag.name) {
        error = 'Closing tag ' + formatEndTagInfo(tag) + ' did not match last open tag `' + element.tag + '` (on line ' + element.loc.start.line + ').';
    }
    if (error) {
        throw new SyntaxError(error, element.loc);
    }
}
function formatEndTagInfo(tag) {
    return '`' + tag.name + '` (on line ' + tag.loc.end.line + ')';
}
var syntax = {
    parse: preprocess,
    builders: builders,
    print: print,
    traverse: traverse,
    Walker: Walker
};
export function preprocess(html, options) {
    var ast = typeof html === 'object' ? html : handlebars.parse(html);
    var program = new TokenizerEventHandlers(html).acceptNode(ast);
    if (options && options.plugins && options.plugins.ast) {
        for (var i = 0, l = options.plugins.ast.length; i < l; i++) {
            var transform = options.plugins.ast[i];
            var env = assign({}, options, { syntax: syntax }, { plugins: undefined });
            var pluginResult = transform(env);
            traverse(program, pluginResult.visitor);
        }
    }
    return program;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIvdG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsT0FBTyxBQUFDLEFBQUUsS0FBRSxBQUFTLEFBQUUsaUJBQU0sQUFBYSxBQUFDO0FBQzNDLEFBQU8sU0FBRSxBQUFXLGFBQUUsQUFBdUIsQUFBRSwrQkFBTSxBQUFVLEFBQUM7QUFDaEUsQUFBTyxTQUFFLEFBQXNCLEFBQUUsOEJBQU0sQUFBNEIsQUFBQztBQUVwRSxPQUFPLEFBQVcsaUJBQU0sQUFBd0IsQUFBQztBQUVqRCxPQUFPLEFBQVEsY0FBTSxBQUFhLEFBQUM7QUFDbkMsT0FBTyxBQUFRLGNBQU0sQUFBdUIsQUFBQztBQUU3QyxPQUFPLEFBQUssV0FBTSxBQUFxQixBQUFDO0FBQ3hDLE9BQU8sQUFBTSxZQUFNLEFBQXFCLEFBQUM7QUFDekMsT0FBTyxLQUFLLEFBQVUsZ0JBQU0sQUFBWSxBQUFDO0FBQ3pDLEFBQU8sU0FBRSxBQUFNLEFBQUUsY0FBTSxBQUFlLEFBQUM7QUFFdkMsQUFBTSxPQUFDLElBQU0sQUFBTyxVQUVoQixBQUFNLE9BQUMsQUFBTSxPQUFDLEFBQUksQUFBQyxBQUFDO0FBRXhCLElBQUksQUFBWSxlQUNkLEFBQXFGLEFBQUM7QUFDeEYsQUFBWSxhQUFDLEFBQUssTUFBQyxBQUFHLEFBQUMsS0FBQyxBQUFPLFFBQUMsQUFBTyxBQUFDLEFBQUUsbUJBQ3hDLEFBQU87WUFBQyxBQUFPLEFBQUMsV0FBRyxBQUFJLEFBQUMsQUFDMUIsQUFBQyxBQUFDLEFBQUM7O0FBRUgsQUFBTSxXQUE4Qjs7Ozs7O3VGQUMxQjs7Y0FBVyxjQUFHLEFBQUMsQUFBQyxBQUNoQjtjQUFhLGdCQUFHLEFBQUMsQUFBQyxBQXNONUIsQUFBQzs7QUFwTkMsQUFBSzs7OERBQ0gsQUFBSTthQUFDLEFBQVcsY0FBRyxBQUFJLEFBQUMsQUFDMUIsQUFBQztBQUVELEFBQVU7QUFFVixBQUFZOzs7NEVBQ1YsQUFBSTthQUFDLEFBQVcsY0FBRyxBQUFDLEVBQUMsQUFBTyxRQUFDLEFBQUUsQUFBQyxBQUFDLEFBQ2pDLEFBQUk7YUFBQyxBQUFXLFlBQUMsQUFBRztvQkFDVixBQUFJLEFBQ1osQUFBSzttQkFBRSxBQUFDLEVBQUMsQUFBRyxJQUFDLEFBQUksS0FBQyxBQUFXLGFBQUUsQUFBSSxLQUFDLEFBQWEsQUFBQyxBQUNsRCxBQUFHO2lCQUhrQixBQUdmLEFBQTRCLEFBQ25DLEFBQUMsQUFDSixBQUFDO0FBSkcsQUFBTTtBQU1WLEFBQW1COzt3RkFBQyxBQUFZLE1BQzlCLEFBQUk7YUFBQyxBQUFjLGVBQUMsQUFBSyxTQUFJLEFBQUksQUFBQyxBQUNwQyxBQUFDO0FBRUQsQUFBYTs7OEVBQ1gsQUFBSTthQUFDLEFBQWMsZUFBQyxBQUFHLElBQUMsQUFBRyxNQUFHLEFBQUMsRUFBQyxBQUFHLElBQUMsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFJLE1BQUUsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFBQyxBQUVoRixBQUFXO29CQUFDLEFBQUksS0FBQyxBQUFjLEFBQUUsa0JBQUUsQUFBSSxLQUFDLEFBQWMsQUFBQyxBQUFDLEFBQzFELEFBQUM7QUFFRCxBQUFPO0FBRVAsQUFBUzs7O3NFQUNQLEFBQUk7YUFBQyxBQUFXLGNBQUcsQUFBQyxFQUFDLEFBQUksQUFBRSxBQUFDLEFBQzVCLEFBQUk7YUFBQyxBQUFXLFlBQUMsQUFBRztvQkFDVixBQUFJLEFBQ1osQUFBSzttQkFBRSxBQUFDLEVBQUMsQUFBRyxJQUFDLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxNQUFFLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBTSxBQUFDLEFBQ3hELEFBQUc7aUJBSGtCLEFBR2YsQUFBNEIsQUFDbkMsQUFBQyxBQUNKLEFBQUM7QUFKRyxBQUFNO0FBTVYsQUFBWTs7MEVBQUMsQUFBWSxNQUN2QixBQUFJO2FBQUMsQUFBVyxZQUFDLEFBQUssU0FBSSxBQUFJLEFBQUMsQUFDakMsQUFBQztBQUVELEFBQVU7O3dFQUNSLEFBQUk7YUFBQyxBQUFXLFlBQUMsQUFBRyxJQUFDLEFBQUcsTUFBRyxBQUFDLEVBQUMsQUFBRyxJQUFDLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxNQUFFLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBTSxBQUFDLEFBQUMsQUFFN0UsQUFBVztvQkFBQyxBQUFJLEtBQUMsQUFBYyxBQUFFLGtCQUFFLEFBQUksS0FBQyxBQUFXLEFBQUMsQUFBQyxBQUN2RCxBQUFDO0FBRUQsQUFBZTtBQUVmLEFBQU87OztrRUFDTCxBQUFJO2FBQUMsQUFBVyxjQUFHLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxBQUFDLEFBQ3ZDLEFBQUk7YUFBQyxBQUFhLGdCQUFHLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBTSxBQUFDLEFBQzdDLEFBQUM7QUFFRCxBQUFhOzs4RUFDWCxBQUFJO2FBQUMsQUFBVztrQkFDUixBQUFVLEFBQ2hCLEFBQUk7a0JBQUUsQUFBRSxBQUNSLEFBQVU7d0JBQUUsQUFBRSxBQUNkLEFBQVM7dUJBQUUsQUFBRSxBQUNiLEFBQVE7c0JBQUUsQUFBRSxBQUNaLEFBQVc7eUJBQUUsQUFBSyxBQUNsQixBQUFHO2lCQVBjLEFBT1osQUFBUyxBQUNmLEFBQUMsQUFDSixBQUFDO0FBUkcsQUFBSTtBQVVSLEFBQVc7OzBFQUNULEFBQUk7YUFBQyxBQUFXO2tCQUNSLEFBQVEsQUFDZCxBQUFJO2tCQUFFLEFBQUUsQUFDUixBQUFVO3dCQUFFLEFBQUUsQUFDZCxBQUFTO3VCQUFFLEFBQUUsQUFDYixBQUFRO3NCQUFFLEFBQUUsQUFDWixBQUFXO3lCQUFFLEFBQUssQUFDbEIsQUFBRztpQkFQYyxBQU9aLEFBQVMsQUFDZixBQUFDLEFBQ0osQUFBQztBQVJHLEFBQUk7QUFVUixBQUFTOzs7QUFDUCxBQUFJLHlCQUFtQixBQUFJLEtBQUMsQUFBUyxBQUFDLEFBRXRDO1lBRk0sQUFBSTtZQUFFLEFBQU0sQUFBRTs7WUFFaEIsQUFBRyxNQUFHLEFBQUksS0FBQyxBQUFVLEFBQUMsQUFDMUIsQUFBRztZQUFDLEFBQUcsTUFBRyxBQUFDLEVBQUMsQUFBRyxJQUFDLEFBQUksS0FBQyxBQUFXLGFBQUUsQUFBSSxLQUFDLEFBQWEsZUFBRSxBQUFJLE1BQUUsQUFBTSxBQUFDLEFBQUMsQUFFcEU7WUFBSSxBQUFHLElBQUMsQUFBSSxTQUFLLEFBQVUsWUFBRSxBQUMzQixBQUFJO2lCQUFDLEFBQWMsQUFBRSxBQUFDLEFBRXRCO2dCQUFJLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBSSxBQUFDLFNBQUksQUFBRyxJQUFDLEFBQVcsYUFBRSxBQUN4QyxBQUFJO3FCQUFDLEFBQVksYUFBQyxBQUFJLEFBQUMsQUFBQyxBQUN6QjtBQUNGO2VBQU0sSUFBSSxBQUFHLElBQUMsQUFBSSxTQUFLLEFBQVEsVUFBRSxBQUNoQyxBQUFJO2lCQUFDLEFBQVksYUFBQyxBQUFLLEFBQUMsQUFBQyxBQUMxQixBQUNIO0FBQUM7QUFFRCxBQUFjOzs7QUFDWixBQUFJLCtCQUF5RCxBQUFJLEtBQUMsQUFBZSxBQUFDLEFBQ2xGO1lBRE0sQUFBSTtZQUFFLEFBQVU7WUFBRSxBQUFTO1lBQUUsQUFBUTtZQUFFLEFBQVcsQUFBRTs7WUFDdEQsQUFBRyxNQUFHLEFBQUMsRUFBQyxBQUFHLElBQUMsQUFBSSxLQUFDLEFBQVcsYUFBRSxBQUFJLEtBQUMsQUFBYSxBQUFDLEFBQUMsQUFDdEQ7WUFBSSxBQUFPLFVBQUcsQUFBQyxFQUFDLEFBQU8sUUFBQyxFQUFFLEFBQUksWUFBRSxBQUFXLEFBQUUsNEJBQUUsQUFBVSxZQUFFLEFBQVMsV0FBRSxBQUFFLElBQUUsQUFBUSxVQUFFLEFBQUUsSUFBRSxBQUFHLEFBQUMsQUFBQyxBQUM3RixBQUFJO2FBQUMsQUFBWSxhQUFDLEFBQUksS0FBQyxBQUFPLEFBQUMsQUFBQyxBQUNsQyxBQUFDO0FBRUQsQUFBWTs7MEVBQUMsQUFBZSxRQUMxQjtZQUFJLEFBQUcsTUFBRyxBQUFJLEtBQUMsQUFBVSxBQUFDLEFBRTFCO1lBQUksQUFBTyxVQUFHLEFBQUksS0FBQyxBQUFZLGFBQUMsQUFBRyxBQUFxQixBQUFDLEFBQ3pEO1lBQUksQUFBTSxTQUFHLEFBQUksS0FBQyxBQUFjLEFBQUUsQUFBQyxBQUVuQyxBQUFjO3VCQUFDLEFBQUcsS0FBRSxBQUFPLFNBQUUsQUFBTSxBQUFDLEFBQUMsQUFFckMsQUFBTztnQkFBQyxBQUFHLElBQUMsQUFBRyxJQUFDLEFBQUksT0FBRyxBQUFJLEtBQUMsQUFBUyxVQUFDLEFBQUksQUFBQyxBQUMzQyxBQUFPO2dCQUFDLEFBQUcsSUFBQyxBQUFHLElBQUMsQUFBTSxTQUFHLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBTSxBQUFDLEFBRS9DLEFBQXVCO2dDQUFDLEFBQU8sQUFBQyxBQUFDLEFBQ2pDLEFBQVc7b0JBQUMsQUFBTSxRQUFFLEFBQU8sQUFBQyxBQUFDLEFBQy9CLEFBQUM7QUFFRCxBQUFvQjs7NEZBQ2xCLEFBQUk7YUFBQyxBQUFVLFdBQUMsQUFBVyxjQUFHLEFBQUksQUFBQyxBQUNyQyxBQUFDO0FBRUQsQUFBYztBQUVkLEFBQWU7OztnRkFBQyxBQUFZLE1BQzFCLEFBQUk7YUFBQyxBQUFVLFdBQUMsQUFBSSxRQUFJLEFBQUksQUFBQyxBQUMvQixBQUFDO0FBRUQsQUFBb0I7QUFFcEIsQUFBYzs7O2dGQUNaO1lBQUksQUFBRyxNQUFHLEFBQUksS0FBQyxBQUFVLEFBQUMsQUFDMUI7WUFBSSxBQUFHLElBQUMsQUFBSSxTQUFLLEFBQVEsVUFBRSxBQUN6QjtrQkFBTSxJQUFJLEFBQVcsWUFDbkIsQUFBeUQsQUFDdkQsc0VBQVEsQUFBRyxJQUFDLEFBQUksdUJBQWUsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFJLEFBQUksY0FDeEQsQUFBRyxJQUFDLEFBQUcsQUFDUixBQUFDLEFBQ0g7QUFFRCxBQUFJO2FBQUMsQUFBZ0I7a0JBQ2IsQUFBRSxBQUNSLEFBQUs7bUJBQUUsQUFBRSxBQUNULEFBQVE7c0JBQUUsQUFBSyxBQUNmLEFBQVM7dUJBQUUsQUFBSyxBQUNoQixBQUFLO21CQUFFLEFBQUMsRUFBQyxBQUFHLElBQUMsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFJLE1BQUUsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFDeEQsQUFBYzs0QkFBRSxBQUFDLEFBQ2pCLEFBQWdCOzhCQVBNLEFBT0osQUFBQyxBQUNwQixBQUFDLEFBQ0osQUFBQztBQVJHLEFBQUk7QUFVUixBQUFxQjs7NEZBQUMsQUFBWSxNQUNoQyxBQUFJO2FBQUMsQUFBVyxZQUFDLEFBQUksUUFBSSxBQUFJLEFBQUMsQUFDaEMsQUFBQztBQUVELEFBQW1COzt3RkFBQyxBQUFpQixVQUNuQyxBQUFJO2FBQUMsQUFBVyxZQUFDLEFBQVEsV0FBRyxBQUFRLEFBQUMsQUFDckMsQUFBSTthQUFDLEFBQVcsWUFBQyxBQUFjLGlCQUFHLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxBQUFDLEFBQ3RELEFBQUk7YUFBQyxBQUFXLFlBQUMsQUFBZ0IsbUJBQUcsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFDNUQsQUFBQztBQUVELEFBQXNCOzs4RkFBQyxBQUFZLE1BQ2pDO1lBQUksQUFBSyxRQUFHLEFBQUksS0FBQyxBQUFXLFlBQUMsQUFBSyxBQUFDLEFBQ25DO1lBQUksQUFBUSxXQUFHLEFBQUssTUFBQyxBQUFLLE1BQUMsQUFBTSxTQUFHLEFBQUMsQUFBQyxBQUFDLEFBRXZDO1lBQUksQUFBUSxZQUFJLEFBQVEsU0FBQyxBQUFJLFNBQUssQUFBVSxZQUFFLEFBQzVDLEFBQVE7cUJBQUMsQUFBSyxTQUFJLEFBQUksQUFBQyxBQUV2QixBQUEwQztBQUMxQyxBQUFRO3FCQUFDLEFBQUcsSUFBQyxBQUFHLElBQUMsQUFBSSxPQUFHLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxBQUFDLEFBQzVDLEFBQVE7cUJBQUMsQUFBRyxJQUFDLEFBQUcsSUFBQyxBQUFNLFNBQUcsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFDakQ7ZUFBTSxBQUNMLEFBQWtEO0FBQ2xEO2dCQUFJLEFBQUcsTUFBRyxBQUFDLEVBQUMsQUFBRyxJQUNiLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxNQUNuQixBQUFJLEtBQUMsQUFBUyxVQUFDLEFBQU0sUUFDckIsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFJLE1BQ25CLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBTSxBQUN0QixBQUFDLEFBRUYsQUFBaUM7QUFDakM7Z0JBQUksQUFBSSxTQUFLLEFBQUksTUFBRSxBQUNqQixBQUFHO29CQUFDLEFBQUssTUFBQyxBQUFJLFFBQUksQUFBQyxBQUFDLEFBQ3BCLEFBQUc7b0JBQUMsQUFBSyxNQUFDLEFBQU0sU0FBRyxBQUFRLEFBQUMsQUFBQyxXQUFDLEFBQVEsU0FBQyxBQUFHLElBQUMsQUFBRyxJQUFDLEFBQU0sQUFBQyxBQUFDLFNBQUMsQUFBSSxLQUFDLEFBQVcsWUFBQyxBQUFnQixBQUFDLEFBQzNGO0FBRUQ7Z0JBQUksQUFBSSxPQUFHLEFBQUMsRUFBQyxBQUFJLEtBQUMsQUFBSSxNQUFFLEFBQUcsQUFBQyxBQUFDLEFBQzdCLEFBQUs7a0JBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxBQUFDLEFBQ2xCLEFBQ0g7QUFBQztBQUVELEFBQW9COzs7QUFDbEIsQUFBSSwyQkFBeUUsQUFBSSxLQUFDLEFBQVcsQUFBQyxBQUM5RjtZQURNLEFBQUk7WUFBRSxBQUFLO1lBQUUsQUFBUTtZQUFFLEFBQVM7WUFBRSxBQUFjO1lBQUUsQUFBZ0IsQUFBRTs7WUFDdEUsQUFBSyxRQUFHLEFBQXNCLHVCQUFDLEFBQUssT0FBRSxBQUFRLFVBQUUsQUFBUyxXQUFFLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxBQUFDLEFBQUMsQUFDcEYsQUFBSztjQUFDLEFBQUcsTUFBRyxBQUFDLEVBQUMsQUFBRyxJQUFDLEFBQWMsZ0JBQUUsQUFBZ0Isa0JBQUUsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFJLE1BQUUsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFBQyxBQUVoRztZQUFJLEFBQUcsTUFBRyxBQUFDLEVBQUMsQUFBRyxJQUNiLEFBQUksS0FBQyxBQUFXLFlBQUMsQUFBSyxNQUFDLEFBQUksTUFDM0IsQUFBSSxLQUFDLEFBQVcsWUFBQyxBQUFLLE1BQUMsQUFBTSxRQUM3QixBQUFJLEtBQUMsQUFBUyxVQUFDLEFBQUksTUFDbkIsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFNLEFBQ3RCLEFBQUMsQUFFRjtZQUFJLEFBQVMsWUFBRyxBQUFDLEVBQUMsQUFBSSxLQUFDLEFBQUksTUFBRSxBQUFLLE9BQUUsQUFBRyxBQUFDLEFBQUMsQUFFekMsQUFBSTthQUFDLEFBQWUsZ0JBQUMsQUFBVSxXQUFDLEFBQUksS0FBQyxBQUFTLEFBQUMsQUFBQyxBQUNsRCxBQUFDO0FBRUQsQUFBaUI7O29GQUFDLEFBQWUsU0FDL0I7Y0FBTSxJQUFJLEFBQVcsQUFDbkIsc0NBQXdCLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxpQkFBUSxBQUFJLEtBQUMsQUFBUyxVQUFDLEFBQU0sZ0JBQUssQUFBTyxBQUFFLFNBQ3RGLEFBQUMsRUFBQyxBQUFHLElBQUMsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFJLE1BQUUsQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFDbEQsQUFBQyxBQUNKLEFBQUMsQUFDRjs7OztFQXhORCxBQUE0QyxBQUFzQjtBQTBObEUsZ0NBQ0UsQUFBK0MsT0FDL0MsQUFBaUIsVUFDakIsQUFBa0IsV0FDbEIsQUFBWSxNQUVaO1FBQUksQUFBUyxXQUFFLEFBQ2I7WUFBSSxBQUFRLFVBQUUsQUFDWjttQkFBTyxBQUF5QiwwQkFBQyxBQUFLLEFBQUMsQUFBQyxBQUN6QztlQUFNLEFBQ0w7Z0JBQ0UsQUFBSyxNQUFDLEFBQU0sV0FBSyxBQUFDLEFBQ2xCLEtBQUMsQUFBSyxNQUFDLEFBQU0sV0FBSyxBQUFDLEtBQ2pCLEFBQUssTUFBQyxBQUFDLEFBQUMsR0FBQyxBQUFJLFNBQUssQUFBVSxjQUMzQixBQUFLLE1BQUMsQUFBQyxBQUFrQixHQUFDLEFBQUssVUFBSyxBQUFHLEFBQUMsS0FDM0MsQUFDQTt1QkFBTyxBQUFLLE1BQUMsQUFBQyxBQUFDLEFBQUMsQUFDakI7bUJBQU0sQUFDTDtzQkFBTSxJQUFJLEFBQVcsWUFDbkIsQUFBOEQsQUFDNUQsQUFBa0QsQUFDbEQsNExBQTZELEFBQUksQUFBRyxhQUN0RSxBQUFDLEVBQUMsQUFBRyxJQUFDLEFBQUksTUFBRSxBQUFDLEFBQUMsQUFDZixBQUFDLEFBQ0g7QUFDRjtBQUNGO1dBQU0sQUFDTDtlQUFPLEFBQUssTUFBQyxBQUFNLFNBQUcsQUFBQyxBQUFDLEFBQUMsSUFBQyxBQUFLLE1BQUMsQUFBQyxBQUFDLEFBQUMsQUFBQyxLQUFDLEFBQUMsRUFBQyxBQUFJLEtBQUMsQUFBRSxBQUFDLEFBQUMsQUFDakQsQUFDSDtBQUFDOztBQUVELG1DQUFtQyxBQUErQyxPQUNoRjtTQUFLLElBQUksQUFBQyxJQUFHLEFBQUMsR0FBRSxBQUFDLElBQUcsQUFBSyxNQUFDLEFBQU0sUUFBRSxBQUFDLEFBQUUsS0FBRSxBQUNyQztZQUFJLEFBQUksT0FBaUIsQUFBSyxNQUFDLEFBQUMsQUFBQyxBQUFDLEFBRWxDO1lBQUksQUFBSSxLQUFDLEFBQUksU0FBSyxBQUFtQix1QkFBSSxBQUFJLEtBQUMsQUFBSSxTQUFLLEFBQVUsWUFBRSxBQUNqRTtrQkFBTSxJQUFJLEFBQVcsWUFDbkIsQUFBOEMsaURBQUcsQUFBSSxLQUFDLEFBQU0sQUFBQyxTQUM3RCxBQUFJLEtBQUMsQUFBRyxBQUNULEFBQUMsQUFDSDtBQUNGO0FBRUQ7V0FBTyxBQUFDLEVBQUMsQUFBTSxPQUFDLEFBQUssQUFBQyxBQUFDLEFBQ3pCLEFBQUM7O0FBRUQsd0JBQ0UsQUFBK0IsS0FDL0IsQUFBd0IsU0FDeEIsQUFBb0IsYUFFcEI7UUFBSSxBQUFLLEFBQUMsQUFFVjtRQUFJLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBSSxBQUFDLFNBQUksQ0FBQyxBQUFXLGFBQUUsQUFDckMsQUFBeUU7QUFDekUsQUFBNEU7QUFDNUUsQUFBa0M7QUFDbEMsQUFBSztnQkFBRyxBQUFrQixxQkFBRyxBQUFnQixpQkFBQyxBQUFHLEFBQUMsT0FBRyxBQUF3QyxBQUFDLEFBQy9GO2VBQVUsQUFBTyxRQUFDLEFBQUcsUUFBSyxBQUFTLFdBQUUsQUFDcEMsQUFBSztnQkFBRyxBQUFjLGlCQUFHLEFBQWdCLGlCQUFDLEFBQUcsQUFBQyxPQUFHLEFBQXVCLEFBQUMsQUFDMUU7QUFGTSxXQUVBLElBQUksQUFBTyxRQUFDLEFBQUcsUUFBSyxBQUFHLElBQUMsQUFBSSxNQUFFLEFBQ25DLEFBQUs7Z0JBQ0gsQUFBYyxpQkFDZCxBQUFnQixpQkFBQyxBQUFHLEFBQUMsT0FDckIsQUFBZ0MsbUNBQ2hDLEFBQU8sUUFBQyxBQUFHLE1BQ1gsQUFBYSxnQkFDYixBQUFPLFFBQUMsQUFBRyxJQUFDLEFBQUssTUFBQyxBQUFJLE9BQ3RCLEFBQUksQUFBQyxBQUNSO0FBRUQ7UUFBSSxBQUFLLE9BQUUsQUFDVDtjQUFNLElBQUksQUFBVyxZQUFDLEFBQUssT0FBRSxBQUFPLFFBQUMsQUFBRyxBQUFDLEFBQUMsQUFDM0MsQUFDSDtBQUFDOztBQUVELDBCQUEwQixBQUErQixLQUN2RDtXQUFPLEFBQUcsTUFBRyxBQUFHLElBQUMsQUFBSSxPQUFHLEFBQWEsZ0JBQUcsQUFBRyxJQUFDLEFBQUcsSUFBQyxBQUFHLElBQUMsQUFBSSxPQUFHLEFBQUcsQUFBQyxBQUNqRSxBQUFDOztBQWtDRCxJQUFNLEFBQU07V0FDSCxBQUFVLEFBQ2pCLEFBQVE7QUFDUixBQUFLO0FBQ0wsQUFBUTtBQUNSLEFBQU0sQUFDUCxBQUFDO0FBTnFCO0FBQ3JCLEFBQUs7QUFPUCxBQUFNLDJCQUFxQixBQUFZLE1BQUUsQUFBMkIsU0FDbEU7UUFBSSxBQUFHLE1BQUcsT0FBTyxBQUFJLFNBQUssQUFBUSxBQUFDLEFBQUMsV0FBQyxBQUFJLEFBQUMsQUFBQyxPQUFDLEFBQVUsV0FBQyxBQUFLLE1BQUMsQUFBSSxBQUFDLEFBQUMsQUFDbkU7UUFBSSxBQUFPLFVBQUcsSUFBSSxBQUFzQix1QkFBQyxBQUFJLEFBQUMsTUFBQyxBQUFVLFdBQUMsQUFBRyxBQUFDLEFBQUMsQUFFL0Q7UUFBSSxBQUFPLFdBQUksQUFBTyxRQUFDLEFBQU8sV0FBSSxBQUFPLFFBQUMsQUFBTyxRQUFDLEFBQUcsS0FBRSxBQUNyRDthQUFLLElBQUksQUFBQyxJQUFHLEFBQUMsR0FBRSxBQUFDLElBQUcsQUFBTyxRQUFDLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBTSxRQUFFLEFBQUMsSUFBRyxBQUFDLEdBQUUsQUFBQyxBQUFFLEtBQUUsQUFDMUQ7Z0JBQUksQUFBUyxZQUFHLEFBQU8sUUFBQyxBQUFPLFFBQUMsQUFBRyxJQUFDLEFBQUMsQUFBQyxBQUFDLEFBQ3ZDO2dCQUFJLEFBQUcsTUFBRyxBQUFNLE9BQUMsQUFBRSxJQUFFLEFBQU8sU0FBRSxFQUFFLEFBQU0sQUFBRSxrQkFBRSxFQUFFLEFBQU8sU0FBRSxBQUFTLEFBQUUsQUFBQyxBQUFDLEFBRWxFO2dCQUFJLEFBQVksZUFBRyxBQUFTLFVBQUMsQUFBRyxBQUFDLEFBQUMsQUFFbEMsQUFBUTtxQkFBQyxBQUFPLFNBQUUsQUFBWSxhQUFDLEFBQU8sQUFBQyxBQUFDLEFBQ3pDO0FBQ0Y7QUFFRDtXQUFPLEFBQU8sQUFBQyxBQUNqQixBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGIsIHsgU1lOVEhFVElDIH0gZnJvbSAnLi4vYnVpbGRlcnMnO1xuaW1wb3J0IHsgYXBwZW5kQ2hpbGQsIHBhcnNlRWxlbWVudEJsb2NrUGFyYW1zIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgSGFuZGxlYmFyc05vZGVWaXNpdG9ycyB9IGZyb20gJy4vaGFuZGxlYmFycy1ub2RlLXZpc2l0b3JzJztcbmltcG9ydCAqIGFzIEFTVCBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5pbXBvcnQgU3ludGF4RXJyb3IgZnJvbSAnLi4vZXJyb3JzL3N5bnRheC1lcnJvcic7XG5pbXBvcnQgeyBUYWcgfSBmcm9tICcuLi9wYXJzZXInO1xuaW1wb3J0IGJ1aWxkZXJzIGZyb20gJy4uL2J1aWxkZXJzJztcbmltcG9ydCB0cmF2ZXJzZSBmcm9tICcuLi90cmF2ZXJzYWwvdHJhdmVyc2UnO1xuaW1wb3J0IHsgTm9kZVZpc2l0b3IgfSBmcm9tICcuLi90eXBlcy92aXNpdG9yJztcbmltcG9ydCBwcmludCBmcm9tICcuLi9nZW5lcmF0aW9uL3ByaW50JztcbmltcG9ydCBXYWxrZXIgZnJvbSAnLi4vdHJhdmVyc2FsL3dhbGtlcic7XG5pbXBvcnQgKiBhcyBoYW5kbGViYXJzIGZyb20gJ2hhbmRsZWJhcnMnO1xuaW1wb3J0IHsgYXNzaWduIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5cbmV4cG9ydCBjb25zdCB2b2lkTWFwOiB7XG4gIFt0YWdOYW1lOiBzdHJpbmddOiBib29sZWFuO1xufSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbmxldCB2b2lkVGFnTmFtZXMgPVxuICAnYXJlYSBiYXNlIGJyIGNvbCBjb21tYW5kIGVtYmVkIGhyIGltZyBpbnB1dCBrZXlnZW4gbGluayBtZXRhIHBhcmFtIHNvdXJjZSB0cmFjayB3YnInO1xudm9pZFRhZ05hbWVzLnNwbGl0KCcgJykuZm9yRWFjaCh0YWdOYW1lID0+IHtcbiAgdm9pZE1hcFt0YWdOYW1lXSA9IHRydWU7XG59KTtcblxuZXhwb3J0IGNsYXNzIFRva2VuaXplckV2ZW50SGFuZGxlcnMgZXh0ZW5kcyBIYW5kbGViYXJzTm9kZVZpc2l0b3JzIHtcbiAgcHJpdmF0ZSB0YWdPcGVuTGluZSA9IDA7XG4gIHByaXZhdGUgdGFnT3BlbkNvbHVtbiA9IDA7XG5cbiAgcmVzZXQoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IG51bGw7XG4gIH1cblxuICAvLyBDb21tZW50XG5cbiAgYmVnaW5Db21tZW50KCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBiLmNvbW1lbnQoJycpO1xuICAgIHRoaXMuY3VycmVudE5vZGUubG9jID0ge1xuICAgICAgc291cmNlOiBudWxsLFxuICAgICAgc3RhcnQ6IGIucG9zKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbiksXG4gICAgICBlbmQ6IChudWxsIGFzIGFueSkgYXMgQVNULlBvc2l0aW9uLFxuICAgIH07XG4gIH1cblxuICBhcHBlbmRUb0NvbW1lbnREYXRhKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudENvbW1lbnQudmFsdWUgKz0gY2hhcjtcbiAgfVxuXG4gIGZpbmlzaENvbW1lbnQoKSB7XG4gICAgdGhpcy5jdXJyZW50Q29tbWVudC5sb2MuZW5kID0gYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKTtcblxuICAgIGFwcGVuZENoaWxkKHRoaXMuY3VycmVudEVsZW1lbnQoKSwgdGhpcy5jdXJyZW50Q29tbWVudCk7XG4gIH1cblxuICAvLyBEYXRhXG5cbiAgYmVnaW5EYXRhKCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBiLnRleHQoKTtcbiAgICB0aGlzLmN1cnJlbnROb2RlLmxvYyA9IHtcbiAgICAgIHNvdXJjZTogbnVsbCxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pLFxuICAgICAgZW5kOiAobnVsbCBhcyBhbnkpIGFzIEFTVC5Qb3NpdGlvbixcbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9EYXRhKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudERhdGEuY2hhcnMgKz0gY2hhcjtcbiAgfVxuXG4gIGZpbmlzaERhdGEoKSB7XG4gICAgdGhpcy5jdXJyZW50RGF0YS5sb2MuZW5kID0gYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKTtcblxuICAgIGFwcGVuZENoaWxkKHRoaXMuY3VycmVudEVsZW1lbnQoKSwgdGhpcy5jdXJyZW50RGF0YSk7XG4gIH1cblxuICAvLyBUYWdzIC0gYmFzaWNcblxuICB0YWdPcGVuKCkge1xuICAgIHRoaXMudGFnT3BlbkxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIHRoaXMudGFnT3BlbkNvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgfVxuXG4gIGJlZ2luU3RhcnRUYWcoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IHtcbiAgICAgIHR5cGU6ICdTdGFydFRhZycsXG4gICAgICBuYW1lOiAnJyxcbiAgICAgIGF0dHJpYnV0ZXM6IFtdLFxuICAgICAgbW9kaWZpZXJzOiBbXSxcbiAgICAgIGNvbW1lbnRzOiBbXSxcbiAgICAgIHNlbGZDbG9zaW5nOiBmYWxzZSxcbiAgICAgIGxvYzogU1lOVEhFVElDLFxuICAgIH07XG4gIH1cblxuICBiZWdpbkVuZFRhZygpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0ge1xuICAgICAgdHlwZTogJ0VuZFRhZycsXG4gICAgICBuYW1lOiAnJyxcbiAgICAgIGF0dHJpYnV0ZXM6IFtdLFxuICAgICAgbW9kaWZpZXJzOiBbXSxcbiAgICAgIGNvbW1lbnRzOiBbXSxcbiAgICAgIHNlbGZDbG9zaW5nOiBmYWxzZSxcbiAgICAgIGxvYzogU1lOVEhFVElDLFxuICAgIH07XG4gIH1cblxuICBmaW5pc2hUYWcoKSB7XG4gICAgbGV0IHsgbGluZSwgY29sdW1uIH0gPSB0aGlzLnRva2VuaXplcjtcblxuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG4gICAgdGFnLmxvYyA9IGIubG9jKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbiwgbGluZSwgY29sdW1uKTtcblxuICAgIGlmICh0YWcudHlwZSA9PT0gJ1N0YXJ0VGFnJykge1xuICAgICAgdGhpcy5maW5pc2hTdGFydFRhZygpO1xuXG4gICAgICBpZiAodm9pZE1hcFt0YWcubmFtZV0gfHwgdGFnLnNlbGZDbG9zaW5nKSB7XG4gICAgICAgIHRoaXMuZmluaXNoRW5kVGFnKHRydWUpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGFnLnR5cGUgPT09ICdFbmRUYWcnKSB7XG4gICAgICB0aGlzLmZpbmlzaEVuZFRhZyhmYWxzZSk7XG4gICAgfVxuICB9XG5cbiAgZmluaXNoU3RhcnRUYWcoKSB7XG4gICAgbGV0IHsgbmFtZSwgYXR0cmlidXRlcywgbW9kaWZpZXJzLCBjb21tZW50cywgc2VsZkNsb3NpbmcgfSA9IHRoaXMuY3VycmVudFN0YXJ0VGFnO1xuICAgIGxldCBsb2MgPSBiLmxvYyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4pO1xuICAgIGxldCBlbGVtZW50ID0gYi5lbGVtZW50KHsgbmFtZSwgc2VsZkNsb3NpbmcgfSwgYXR0cmlidXRlcywgbW9kaWZpZXJzLCBbXSwgY29tbWVudHMsIFtdLCBsb2MpO1xuICAgIHRoaXMuZWxlbWVudFN0YWNrLnB1c2goZWxlbWVudCk7XG4gIH1cblxuICBmaW5pc2hFbmRUYWcoaXNWb2lkOiBib29sZWFuKSB7XG4gICAgbGV0IHRhZyA9IHRoaXMuY3VycmVudFRhZztcblxuICAgIGxldCBlbGVtZW50ID0gdGhpcy5lbGVtZW50U3RhY2sucG9wKCkgYXMgQVNULkVsZW1lbnROb2RlO1xuICAgIGxldCBwYXJlbnQgPSB0aGlzLmN1cnJlbnRFbGVtZW50KCk7XG5cbiAgICB2YWxpZGF0ZUVuZFRhZyh0YWcsIGVsZW1lbnQsIGlzVm9pZCk7XG5cbiAgICBlbGVtZW50LmxvYy5lbmQubGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmU7XG4gICAgZWxlbWVudC5sb2MuZW5kLmNvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcblxuICAgIHBhcnNlRWxlbWVudEJsb2NrUGFyYW1zKGVsZW1lbnQpO1xuICAgIGFwcGVuZENoaWxkKHBhcmVudCwgZWxlbWVudCk7XG4gIH1cblxuICBtYXJrVGFnQXNTZWxmQ2xvc2luZygpIHtcbiAgICB0aGlzLmN1cnJlbnRUYWcuc2VsZkNsb3NpbmcgPSB0cnVlO1xuICB9XG5cbiAgLy8gVGFncyAtIG5hbWVcblxuICBhcHBlbmRUb1RhZ05hbWUoY2hhcjogc3RyaW5nKSB7XG4gICAgdGhpcy5jdXJyZW50VGFnLm5hbWUgKz0gY2hhcjtcbiAgfVxuXG4gIC8vIFRhZ3MgLSBhdHRyaWJ1dGVzXG5cbiAgYmVnaW5BdHRyaWJ1dGUoKSB7XG4gICAgbGV0IHRhZyA9IHRoaXMuY3VycmVudFRhZztcbiAgICBpZiAodGFnLnR5cGUgPT09ICdFbmRUYWcnKSB7XG4gICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIGVuZCB0YWc6IGNsb3NpbmcgdGFnIG11c3Qgbm90IGhhdmUgYXR0cmlidXRlcywgYCArXG4gICAgICAgICAgYGluIFxcYCR7dGFnLm5hbWV9XFxgIChvbiBsaW5lICR7dGhpcy50b2tlbml6ZXIubGluZX0pLmAsXG4gICAgICAgIHRhZy5sb2NcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50QXR0cmlidXRlID0ge1xuICAgICAgbmFtZTogJycsXG4gICAgICBwYXJ0czogW10sXG4gICAgICBpc1F1b3RlZDogZmFsc2UsXG4gICAgICBpc0R5bmFtaWM6IGZhbHNlLFxuICAgICAgc3RhcnQ6IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbiksXG4gICAgICB2YWx1ZVN0YXJ0TGluZTogMCxcbiAgICAgIHZhbHVlU3RhcnRDb2x1bW46IDAsXG4gICAgfTtcbiAgfVxuXG4gIGFwcGVuZFRvQXR0cmlidXRlTmFtZShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLm5hbWUgKz0gY2hhcjtcbiAgfVxuXG4gIGJlZ2luQXR0cmlidXRlVmFsdWUoaXNRdW90ZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLmlzUXVvdGVkID0gaXNRdW90ZWQ7XG4gICAgdGhpcy5jdXJyZW50QXR0ci52YWx1ZVN0YXJ0TGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmU7XG4gICAgdGhpcy5jdXJyZW50QXR0ci52YWx1ZVN0YXJ0Q29sdW1uID0gdGhpcy50b2tlbml6ZXIuY29sdW1uO1xuICB9XG5cbiAgYXBwZW5kVG9BdHRyaWJ1dGVWYWx1ZShjaGFyOiBzdHJpbmcpIHtcbiAgICBsZXQgcGFydHMgPSB0aGlzLmN1cnJlbnRBdHRyLnBhcnRzO1xuICAgIGxldCBsYXN0UGFydCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdO1xuXG4gICAgaWYgKGxhc3RQYXJ0ICYmIGxhc3RQYXJ0LnR5cGUgPT09ICdUZXh0Tm9kZScpIHtcbiAgICAgIGxhc3RQYXJ0LmNoYXJzICs9IGNoYXI7XG5cbiAgICAgIC8vIHVwZGF0ZSBlbmQgbG9jYXRpb24gZm9yIGVhY2ggYWRkZWQgY2hhclxuICAgICAgbGFzdFBhcnQubG9jLmVuZC5saW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICAgIGxhc3RQYXJ0LmxvYy5lbmQuY29sdW1uID0gdGhpcy50b2tlbml6ZXIuY29sdW1uO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBpbml0aWFsbHkgYXNzdW1lIHRoZSB0ZXh0IG5vZGUgaXMgYSBzaW5nbGUgY2hhclxuICAgICAgbGV0IGxvYyA9IGIubG9jKFxuICAgICAgICB0aGlzLnRva2VuaXplci5saW5lLFxuICAgICAgICB0aGlzLnRva2VuaXplci5jb2x1bW4sXG4gICAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsXG4gICAgICAgIHRoaXMudG9rZW5pemVyLmNvbHVtblxuICAgICAgKTtcblxuICAgICAgLy8gY29ycmVjdCBmb3IgYFxcbmAgYXMgZmlyc3QgY2hhclxuICAgICAgaWYgKGNoYXIgPT09ICdcXG4nKSB7XG4gICAgICAgIGxvYy5zdGFydC5saW5lIC09IDE7XG4gICAgICAgIGxvYy5zdGFydC5jb2x1bW4gPSBsYXN0UGFydCA/IGxhc3RQYXJ0LmxvYy5lbmQuY29sdW1uIDogdGhpcy5jdXJyZW50QXR0ci52YWx1ZVN0YXJ0Q29sdW1uO1xuICAgICAgfVxuXG4gICAgICBsZXQgdGV4dCA9IGIudGV4dChjaGFyLCBsb2MpO1xuICAgICAgcGFydHMucHVzaCh0ZXh0KTtcbiAgICB9XG4gIH1cblxuICBmaW5pc2hBdHRyaWJ1dGVWYWx1ZSgpIHtcbiAgICBsZXQgeyBuYW1lLCBwYXJ0cywgaXNRdW90ZWQsIGlzRHluYW1pYywgdmFsdWVTdGFydExpbmUsIHZhbHVlU3RhcnRDb2x1bW4gfSA9IHRoaXMuY3VycmVudEF0dHI7XG4gICAgbGV0IHZhbHVlID0gYXNzZW1ibGVBdHRyaWJ1dGVWYWx1ZShwYXJ0cywgaXNRdW90ZWQsIGlzRHluYW1pYywgdGhpcy50b2tlbml6ZXIubGluZSk7XG4gICAgdmFsdWUubG9jID0gYi5sb2ModmFsdWVTdGFydExpbmUsIHZhbHVlU3RhcnRDb2x1bW4sIHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBsZXQgbG9jID0gYi5sb2MoXG4gICAgICB0aGlzLmN1cnJlbnRBdHRyLnN0YXJ0LmxpbmUsXG4gICAgICB0aGlzLmN1cnJlbnRBdHRyLnN0YXJ0LmNvbHVtbixcbiAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsXG4gICAgICB0aGlzLnRva2VuaXplci5jb2x1bW5cbiAgICApO1xuXG4gICAgbGV0IGF0dHJpYnV0ZSA9IGIuYXR0cihuYW1lLCB2YWx1ZSwgbG9jKTtcblxuICAgIHRoaXMuY3VycmVudFN0YXJ0VGFnLmF0dHJpYnV0ZXMucHVzaChhdHRyaWJ1dGUpO1xuICB9XG5cbiAgcmVwb3J0U3ludGF4RXJyb3IobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgYFN5bnRheCBlcnJvciBhdCBsaW5lICR7dGhpcy50b2tlbml6ZXIubGluZX0gY29sICR7dGhpcy50b2tlbml6ZXIuY29sdW1ufTogJHttZXNzYWdlfWAsXG4gICAgICBiLmxvYyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlbWJsZUF0dHJpYnV0ZVZhbHVlKFxuICBwYXJ0czogKEFTVC5NdXN0YWNoZVN0YXRlbWVudCB8IEFTVC5UZXh0Tm9kZSlbXSxcbiAgaXNRdW90ZWQ6IGJvb2xlYW4sXG4gIGlzRHluYW1pYzogYm9vbGVhbixcbiAgbGluZTogbnVtYmVyXG4pIHtcbiAgaWYgKGlzRHluYW1pYykge1xuICAgIGlmIChpc1F1b3RlZCkge1xuICAgICAgcmV0dXJuIGFzc2VtYmxlQ29uY2F0ZW5hdGVkVmFsdWUocGFydHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoXG4gICAgICAgIHBhcnRzLmxlbmd0aCA9PT0gMSB8fFxuICAgICAgICAocGFydHMubGVuZ3RoID09PSAyICYmXG4gICAgICAgICAgcGFydHNbMV0udHlwZSA9PT0gJ1RleHROb2RlJyAmJlxuICAgICAgICAgIChwYXJ0c1sxXSBhcyBBU1QuVGV4dE5vZGUpLmNoYXJzID09PSAnLycpXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIHBhcnRzWzBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICAgIGBBbiB1bnF1b3RlZCBhdHRyaWJ1dGUgdmFsdWUgbXVzdCBiZSBhIHN0cmluZyBvciBhIG11c3RhY2hlLCBgICtcbiAgICAgICAgICAgIGBwcmVjZWVkZWQgYnkgd2hpdGVzcGFjZSBvciBhICc9JyBjaGFyYWN0ZXIsIGFuZCBgICtcbiAgICAgICAgICAgIGBmb2xsb3dlZCBieSB3aGl0ZXNwYWNlLCBhICc+JyBjaGFyYWN0ZXIsIG9yICcvPicgKG9uIGxpbmUgJHtsaW5lfSlgLFxuICAgICAgICAgIGIubG9jKGxpbmUsIDApXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBwYXJ0cy5sZW5ndGggPiAwID8gcGFydHNbMF0gOiBiLnRleHQoJycpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlQ29uY2F0ZW5hdGVkVmFsdWUocGFydHM6IChBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUpW10pIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgIGxldCBwYXJ0OiBBU1QuQmFzZU5vZGUgPSBwYXJ0c1tpXTtcblxuICAgIGlmIChwYXJ0LnR5cGUgIT09ICdNdXN0YWNoZVN0YXRlbWVudCcgJiYgcGFydC50eXBlICE9PSAnVGV4dE5vZGUnKSB7XG4gICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICAgICdVbnN1cHBvcnRlZCBub2RlIGluIHF1b3RlZCBhdHRyaWJ1dGUgdmFsdWU6ICcgKyBwYXJ0Wyd0eXBlJ10sXG4gICAgICAgIHBhcnQubG9jXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBiLmNvbmNhdChwYXJ0cyk7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlRW5kVGFnKFxuICB0YWc6IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+LFxuICBlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUsXG4gIHNlbGZDbG9zaW5nOiBib29sZWFuXG4pIHtcbiAgbGV0IGVycm9yO1xuXG4gIGlmICh2b2lkTWFwW3RhZy5uYW1lXSAmJiAhc2VsZkNsb3NpbmcpIHtcbiAgICAvLyBFbmdUYWcgaXMgYWxzbyBjYWxsZWQgYnkgU3RhcnRUYWcgZm9yIHZvaWQgYW5kIHNlbGYtY2xvc2luZyB0YWdzIChpLmUuXG4gICAgLy8gPGlucHV0PiBvciA8YnIgLz4sIHNvIHdlIG5lZWQgdG8gY2hlY2sgZm9yIHRoYXQgaGVyZS4gT3RoZXJ3aXNlLCB3ZSB3b3VsZFxuICAgIC8vIHRocm93IGFuIGVycm9yIGZvciB0aG9zZSBjYXNlcy5cbiAgICBlcnJvciA9ICdJbnZhbGlkIGVuZCB0YWcgJyArIGZvcm1hdEVuZFRhZ0luZm8odGFnKSArICcgKHZvaWQgZWxlbWVudHMgY2Fubm90IGhhdmUgZW5kIHRhZ3MpLic7XG4gIH0gZWxzZSBpZiAoZWxlbWVudC50YWcgPT09IHVuZGVmaW5lZCkge1xuICAgIGVycm9yID0gJ0Nsb3NpbmcgdGFnICcgKyBmb3JtYXRFbmRUYWdJbmZvKHRhZykgKyAnIHdpdGhvdXQgYW4gb3BlbiB0YWcuJztcbiAgfSBlbHNlIGlmIChlbGVtZW50LnRhZyAhPT0gdGFnLm5hbWUpIHtcbiAgICBlcnJvciA9XG4gICAgICAnQ2xvc2luZyB0YWcgJyArXG4gICAgICBmb3JtYXRFbmRUYWdJbmZvKHRhZykgK1xuICAgICAgJyBkaWQgbm90IG1hdGNoIGxhc3Qgb3BlbiB0YWcgYCcgK1xuICAgICAgZWxlbWVudC50YWcgK1xuICAgICAgJ2AgKG9uIGxpbmUgJyArXG4gICAgICBlbGVtZW50LmxvYy5zdGFydC5saW5lICtcbiAgICAgICcpLic7XG4gIH1cblxuICBpZiAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoZXJyb3IsIGVsZW1lbnQubG9jKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBmb3JtYXRFbmRUYWdJbmZvKHRhZzogVGFnPCdTdGFydFRhZycgfCAnRW5kVGFnJz4pIHtcbiAgcmV0dXJuICdgJyArIHRhZy5uYW1lICsgJ2AgKG9uIGxpbmUgJyArIHRhZy5sb2MuZW5kLmxpbmUgKyAnKSc7XG59XG5cbi8qKlxuICBBU1RQbHVnaW5zIGNhbiBtYWtlIGNoYW5nZXMgdG8gdGhlIEdsaW1tZXIgdGVtcGxhdGUgQVNUIGJlZm9yZVxuICBjb21waWxhdGlvbiBiZWdpbnMuXG4qL1xuZXhwb3J0IGludGVyZmFjZSBBU1RQbHVnaW5CdWlsZGVyIHtcbiAgKGVudjogQVNUUGx1Z2luRW52aXJvbm1lbnQpOiBBU1RQbHVnaW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luIHtcbiAgbmFtZTogc3RyaW5nO1xuICB2aXNpdG9yOiBOb2RlVmlzaXRvcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBU1RQbHVnaW5FbnZpcm9ubWVudCB7XG4gIG1ldGE/OiBhbnk7XG4gIHN5bnRheDogU3ludGF4O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFByZXByb2Nlc3NPcHRpb25zIHtcbiAgcGx1Z2lucz86IHtcbiAgICBhc3Q/OiBBU1RQbHVnaW5CdWlsZGVyW107XG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3ludGF4IHtcbiAgcGFyc2U6IHR5cGVvZiBwcmVwcm9jZXNzO1xuICBidWlsZGVyczogdHlwZW9mIGJ1aWxkZXJzO1xuICBwcmludDogdHlwZW9mIHByaW50O1xuICB0cmF2ZXJzZTogdHlwZW9mIHRyYXZlcnNlO1xuICBXYWxrZXI6IHR5cGVvZiBXYWxrZXI7XG59XG5cbmNvbnN0IHN5bnRheDogU3ludGF4ID0ge1xuICBwYXJzZTogcHJlcHJvY2VzcyxcbiAgYnVpbGRlcnMsXG4gIHByaW50LFxuICB0cmF2ZXJzZSxcbiAgV2Fsa2VyLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHByZXByb2Nlc3MoaHRtbDogc3RyaW5nLCBvcHRpb25zPzogUHJlcHJvY2Vzc09wdGlvbnMpOiBBU1QuUHJvZ3JhbSB7XG4gIGxldCBhc3QgPSB0eXBlb2YgaHRtbCA9PT0gJ29iamVjdCcgPyBodG1sIDogaGFuZGxlYmFycy5wYXJzZShodG1sKTtcbiAgbGV0IHByb2dyYW0gPSBuZXcgVG9rZW5pemVyRXZlbnRIYW5kbGVycyhodG1sKS5hY2NlcHROb2RlKGFzdCk7XG5cbiAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wbHVnaW5zICYmIG9wdGlvbnMucGx1Z2lucy5hc3QpIHtcbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IG9wdGlvbnMucGx1Z2lucy5hc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICBsZXQgdHJhbnNmb3JtID0gb3B0aW9ucy5wbHVnaW5zLmFzdFtpXTtcbiAgICAgIGxldCBlbnYgPSBhc3NpZ24oe30sIG9wdGlvbnMsIHsgc3ludGF4IH0sIHsgcGx1Z2luczogdW5kZWZpbmVkIH0pO1xuXG4gICAgICBsZXQgcGx1Z2luUmVzdWx0ID0gdHJhbnNmb3JtKGVudik7XG5cbiAgICAgIHRyYXZlcnNlKHByb2dyYW0sIHBsdWdpblJlc3VsdC52aXNpdG9yKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcHJvZ3JhbTtcbn1cbiJdfQ==