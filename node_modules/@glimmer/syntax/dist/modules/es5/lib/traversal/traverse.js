import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
function getEnterFunction(handler) {
    return typeof handler === 'function' ? handler : handler.enter;
}
function getExitFunction(handler) {
    return typeof handler !== 'function' ? handler.exit : undefined;
}
function getKeyHandler(handler, key) {
    var keyVisitor = typeof handler !== 'function' ? handler.keys : undefined;
    if (keyVisitor === undefined) return;
    var keyHandler = keyVisitor[key];
    if (keyHandler !== undefined) {
        // widen specific key to all keys
        return keyHandler;
    }
    return keyVisitor.All;
}
function getNodeHandler(visitor, nodeType) {
    var handler = visitor[nodeType];
    if (handler !== undefined) {
        // widen specific Node to all nodes
        return handler;
    }
    return visitor.All;
}
function visitNode(visitor, node) {
    var handler = getNodeHandler(visitor, node.type);
    var enter = void 0;
    var exit = void 0;
    if (handler !== undefined) {
        enter = getEnterFunction(handler);
        exit = getExitFunction(handler);
    }
    var result = void 0;
    if (enter !== undefined) {
        result = enter(node);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            return visitArray(visitor, result) || result;
        } else {
            return visitNode(visitor, result) || result;
        }
    }
    if (result === undefined) {
        var keys = visitorKeys[node.type];
        for (var i = 0; i < keys.length; i++) {
            // we know if it has child keys we can widen to a ParentNode
            visitKey(visitor, handler, node, keys[i]);
        }
        if (exit !== undefined) {
            result = exit(node);
        }
    }
    return result;
}
function visitKey(visitor, handler, node, key) {
    var value = node[key];
    if (!value) {
        return;
    }
    var keyEnter = void 0;
    var keyExit = void 0;
    if (handler !== undefined) {
        var keyHandler = getKeyHandler(handler, key);
        if (keyHandler !== undefined) {
            keyEnter = getEnterFunction(keyHandler);
            keyExit = getExitFunction(keyHandler);
        }
    }
    if (keyEnter !== undefined) {
        if (keyEnter(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value);
    } else {
        var result = visitNode(visitor, value);
        if (result !== undefined) {
            assignKey(node, key, result);
        }
    }
    if (keyExit !== undefined) {
        if (keyExit(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
}
function visitArray(visitor, array) {
    for (var i = 0; i < array.length; i++) {
        var result = visitNode(visitor, array[i]);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, result) {
    if (result === null) {
        throw cannotRemoveNode(node[key], node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            node[key] = result[0];
        } else {
            if (result.length === 0) {
                throw cannotRemoveNode(node[key], node, key);
            } else {
                throw cannotReplaceNode(node[key], node, key);
            }
        }
    } else {
        node[key] = result;
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice.apply(array, [index, 1].concat(result));
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
export default function traverse(node, visitor) {
    visitNode(visitor, node);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL3RyYXZlcnNhbC90cmF2ZXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEFBQVcsaUJBQU0sQUFBdUIsQUFBQztBQUNoRCxBQUFPLFNBQ0wsQUFBZ0Isa0JBQ2hCLEFBQWlCLG1CQUNqQixBQUFvQyxBQUNyQyw0Q0FBTSxBQUFVLEFBQUM7QUFNbEIsMEJBQ0UsQUFBaUMsU0FFakM7V0FBTyxPQUFPLEFBQU8sWUFBSyxBQUFVLEFBQUMsQUFBQyxhQUFDLEFBQU8sQUFBQyxBQUFDLFVBQUMsQUFBTyxRQUFDLEFBQUssQUFBQyxBQUNqRSxBQUFDOztBQUlELHlCQUNFLEFBQWlDLFNBRWpDO1dBQU8sT0FBTyxBQUFPLFlBQUssQUFBVSxBQUFDLEFBQUMsYUFBQyxBQUFPLFFBQUMsQUFBSSxBQUFDLEFBQUMsT0FBQyxBQUFTLEFBQUMsQUFDbEUsQUFBQzs7QUFFRCx1QkFBdUIsQUFBb0IsU0FBRSxBQUFhLEtBQ3hEO1FBQUksQUFBVSxhQUFHLE9BQU8sQUFBTyxZQUFLLEFBQVUsQUFBQyxBQUFDLGFBQUMsQUFBTyxRQUFDLEFBQUksQUFBQyxBQUFDLE9BQUMsQUFBUyxBQUFDLEFBQzFFO1FBQUksQUFBVSxlQUFLLEFBQVMsV0FBRSxBQUFPLEFBQ3JDO1FBQUksQUFBVSxhQUFHLEFBQVUsV0FBQyxBQUFHLEFBQUMsQUFBQyxBQUNqQztRQUFJLEFBQVUsZUFBSyxBQUFTLFdBQUUsQUFDNUIsQUFBaUM7QUFDakM7ZUFBTyxBQUF3QixBQUFDLEFBQ2pDO0FBQ0Q7V0FBTyxBQUFVLFdBQUMsQUFBRyxBQUFDLEFBQ3hCLEFBQUM7O0FBRUQsd0JBQXdCLEFBQW9CLFNBQUUsQUFBa0IsVUFDOUQ7UUFBSSxBQUFPLFVBQUcsQUFBTyxRQUFDLEFBQVEsQUFBQyxBQUFDLEFBQ2hDO1FBQUksQUFBTyxZQUFL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LEFBQUMsQUFBQyxBQUFDLEFBQ3ZCO2VBQU0sQUFDTDtnQkFBSSxBQUFNLE9BQUMsQUFBTSxXQUFLLEFBQUMsR0FBRSxBQUN2QjtzQkFBTSxBQUFnQixpQkFBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLE1BQUUsQUFBSSxNQUFFLEFBQUcsQUFBQyxBQUFDLEFBQzlDO21CQUFNLEFBQ0w7c0JBQU0sQUFBaUIsa0JBQUMsQUFBSSxLQUFDLEFBQUcsQUFBQyxNQUFFLEFBQUksTUFBRSxBQUFHLEFBQUMsQUFBQyxBQUMvQztBQUNGO0FBQ0Y7QUFWTSxXQVVBLEFBQ0wsQUFBSTthQUFDLEFBQUcsQUFBQyxPQUFHLEFBQU0sQUFBQyxBQUNwQixBQUNIO0FBQUM7O0FBRUQscUJBQXFCLEFBQWEsT0FBRSxBQUFhLE9BQUUsQUFBNEIsUUFDN0U7UUFBSSxBQUFNLFdBQUssQUFBSSxNQUFFLEFBQ25CLEFBQUs7Y0FBQyxBQUFNLE9BQUMsQUFBSyxPQUFFLEFBQUMsQUFBQyxBQUFDLEFBQ3ZCO2VBQU8sQUFBQyxBQUFDLEFBQ1Y7ZUFBVSxBQUFLLE1BQUMsQUFBTyxRQUFDLEFBQU0sQUFBQyxTQUFFLEFBQ2hDLEFBQUs7Y0FBQyxBQUFNLHFCQUFDLEFBQUssT0FBRSxBQUFDLEFBQUUsVUFBRyxBQUFNLEFBQUMsQUFBQyxBQUNsQztlQUFPLEFBQU0sT0FBQyxBQUFNLEFBQUMsQUFDdEI7QUFITSxXQUdBLEFBQ0wsQUFBSztjQUFDLEFBQU0sT0FBQyxBQUFLLE9BQUUsQUFBQyxHQUFFLEFBQU0sQUFBQyxBQUFDLEFBQy9CO2VBQU8sQUFBQyxBQUFDLEFBQ1YsQUFDSDtBQUFDOztBQUVELEFBQU0sQUFBQyxBQUFPLGlDQUFtQixBQUFVLE1BQUUsQUFBb0IsU0FDL0QsQUFBUztjQUFDLEFBQU8sU0FBRSxBQUFJLEFBQUMsQUFBQyxBQUMzQixBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHZpc2l0b3JLZXlzIGZyb20gJy4uL3R5cGVzL3Zpc2l0b3Ita2V5cyc7XG5pbXBvcnQge1xuICBjYW5ub3RSZW1vdmVOb2RlLFxuICBjYW5ub3RSZXBsYWNlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0LFxufSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgeyBOb2RlLCBOb2RlVHlwZSwgUGFyZW50Tm9kZSwgQ2hpbGRLZXkgfSBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5pbXBvcnQgeyBOb2RlVmlzaXRvciwgTm9kZUZ1bmN0aW9uLCBOb2RlSGFuZGxlciwgS2V5RnVuY3Rpb24sIEtleUhhbmRsZXIgfSBmcm9tICcuLi90eXBlcy92aXNpdG9yJztcblxuZnVuY3Rpb24gZ2V0RW50ZXJGdW5jdGlvbihoYW5kbGVyOiBLZXlIYW5kbGVyKTogS2V5RnVuY3Rpb24gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFbnRlckZ1bmN0aW9uKGhhbmRsZXI6IE5vZGVIYW5kbGVyKTogTm9kZUZ1bmN0aW9uIHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RW50ZXJGdW5jdGlvbihcbiAgaGFuZGxlcjogTm9kZUhhbmRsZXIgfCBLZXlIYW5kbGVyXG4pOiBOb2RlRnVuY3Rpb24gfCBLZXlGdW5jdGlvbiB8IHVuZGVmaW5lZCB7XG4gIHJldHVybiB0eXBlb2YgaGFuZGxlciA9PT0gJ2Z1bmN0aW9uJyA/IGhhbmRsZXIgOiBoYW5kbGVyLmVudGVyO1xufVxuXG5mdW5jdGlvbiBnZXRFeGl0RnVuY3Rpb24oaGFuZGxlcjogS2V5SGFuZGxlcik6IEtleUZ1bmN0aW9uIHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uKGhhbmRsZXI6IE5vZGVIYW5kbGVyKTogTm9kZUZ1bmN0aW9uIHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uKFxuICBoYW5kbGVyOiBOb2RlSGFuZGxlciB8IEtleUhhbmRsZXJcbik6IE5vZGVGdW5jdGlvbiB8IEtleUZ1bmN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgcmV0dXJuIHR5cGVvZiBoYW5kbGVyICE9PSAnZnVuY3Rpb24nID8gaGFuZGxlci5leGl0IDogdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBnZXRLZXlIYW5kbGVyKGhhbmRsZXI6IE5vZGVIYW5kbGVyLCBrZXk6IENoaWxkS2V5KTogS2V5SGFuZGxlciB8IHVuZGVmaW5lZCB7XG4gIGxldCBrZXlWaXNpdG9yID0gdHlwZW9mIGhhbmRsZXIgIT09ICdmdW5jdGlvbicgPyBoYW5kbGVyLmtleXMgOiB1bmRlZmluZWQ7XG4gIGlmIChrZXlWaXNpdG9yID09PSB1bmRlZmluZWQpIHJldHVybjtcbiAgbGV0IGtleUhhbmRsZXIgPSBrZXlWaXNpdG9yW2tleV07XG4gIGlmIChrZXlIYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAvLyB3aWRlbiBzcGVjaWZpYyBrZXkgdG8gYWxsIGtleXNcbiAgICByZXR1cm4ga2V5SGFuZGxlciBhcyBLZXlIYW5kbGVyO1xuICB9XG4gIHJldHVybiBrZXlWaXNpdG9yLkFsbDtcbn1cblxuZnVuY3Rpb24gZ2V0Tm9kZUhhbmRsZXIodmlzaXRvcjogTm9kZVZpc2l0b3IsIG5vZGVUeXBlOiBOb2RlVHlwZSk6IE5vZGVIYW5kbGVyIHwgdW5kZWZpbmVkIHtcbiAgbGV0IGhhbmRsZXIgPSB2aXNpdG9yW25vZGVUeXBlXTtcbiAgaWYgKGhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIC8vIHdpZGVuIHNwZWNpZmljIE5vZGUgdG8gYWxsIG5vZGVzXG4gICAgcmV0dXJuIGhhbmRsZXIgYXMgTm9kZUhhbmRsZXI7XG4gIH1cbiAgcmV0dXJuIHZpc2l0b3IuQWxsO1xufVxuXG5mdW5jdGlvbiB2aXNpdE5vZGUodmlzaXRvcjogTm9kZVZpc2l0b3IsIG5vZGU6IE5vZGUpOiBOb2RlIHwgTm9kZVtdIHwgdW5kZWZpbmVkIHwgbnVsbCB8IHZvaWQge1xuICBsZXQgaGFuZGxlciA9IGdldE5vZGVIYW5kbGVyKHZpc2l0b3IsIG5vZGUudHlwZSk7XG4gIGxldCBlbnRlcjogTm9kZUZ1bmN0aW9uIHwgdW5kZWZpbmVkO1xuICBsZXQgZXhpdDogTm9kZUZ1bmN0aW9uIHwgdW5kZWZpbmVkO1xuXG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICBlbnRlciA9IGdldEVudGVyRnVuY3Rpb24oaGFuZGxlcik7XG4gICAgZXhpdCA9IGdldEV4aXRGdW5jdGlvbihoYW5kbGVyKTtcbiAgfVxuXG4gIGxldCByZXN1bHQ6IE5vZGUgfCBOb2RlW10gfCB1bmRlZmluZWQgfCBudWxsIHwgdm9pZDtcbiAgaWYgKGVudGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXN1bHQgPSBlbnRlcihub2RlKTtcbiAgfVxuXG4gIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCAmJiByZXN1bHQgIT09IG51bGwpIHtcbiAgICBpZiAoSlNPTi5zdHJpbmdpZnkobm9kZSkgPT09IEpTT04uc3RyaW5naWZ5KHJlc3VsdCkpIHtcbiAgICAgIHJlc3VsdCA9IHVuZGVmaW5lZDtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgcmV0dXJuIHZpc2l0QXJyYXkodmlzaXRvciwgcmVzdWx0KSB8fCByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB2aXNpdE5vZGUodmlzaXRvciwgcmVzdWx0KSB8fCByZXN1bHQ7XG4gICAgfVxuICB9XG5cbiAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgbGV0IGtleXMgPSB2aXNpdG9yS2V5c1tub2RlLnR5cGVdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAvLyB3ZSBrbm93IGlmIGl0IGhhcyBjaGlsZCBrZXlzIHdlIGNhbiB3aWRlbiB0byBhIFBhcmVudE5vZGVcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIsIG5vZGUgYXMgUGFyZW50Tm9kZSwga2V5c1tpXSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmVzdWx0ID0gZXhpdChub2RlKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiB2aXNpdEtleShcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIGhhbmRsZXI6IE5vZGVIYW5kbGVyIHwgdW5kZWZpbmVkLFxuICBub2RlOiBQYXJlbnROb2RlLFxuICBrZXk6IENoaWxkS2V5XG4pIHtcbiAgbGV0IHZhbHVlID0gbm9kZVtrZXldIGFzIE5vZGUgfCBOb2RlW10gfCBudWxsIHwgdW5kZWZpbmVkO1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IGtleUVudGVyOiBLZXlGdW5jdGlvbiB8IHVuZGVmaW5lZDtcbiAgbGV0IGtleUV4aXQ6IEtleUZ1bmN0aW9uIHwgdW5kZWZpbmVkO1xuXG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICBsZXQga2V5SGFuZGxlciA9IGdldEtleUhhbmRsZXIoaGFuZGxlciwga2V5KTtcbiAgICBpZiAoa2V5SGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBrZXlFbnRlciA9IGdldEVudGVyRnVuY3Rpb24oa2V5SGFuZGxlcik7XG4gICAgICBrZXlFeGl0ID0gZ2V0RXhpdEZ1bmN0aW9uKGtleUhhbmRsZXIpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChrZXlFbnRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGtleUVudGVyKG5vZGUsIGtleSkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0KG5vZGUsIGtleSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgdmlzaXRBcnJheSh2aXNpdG9yLCB2YWx1ZSk7XG4gIH0gZWxzZSB7XG4gICAgbGV0IHJlc3VsdCA9IHZpc2l0Tm9kZSh2aXNpdG9yLCB2YWx1ZSk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBhc3NpZ25LZXkobm9kZSwga2V5LCByZXN1bHQpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChrZXlFeGl0ICE9PSB1bmRlZmluZWQpIHtcbiAgICBpZiAoa2V5RXhpdChub2RlLCBrZXkpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB2aXNpdEFycmF5KHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBhcnJheTogTm9kZVtdKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgcmVzdWx0ID0gdmlzaXROb2RlKHZpc2l0b3IsIGFycmF5W2ldKTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGkgKz0gc3BsaWNlQXJyYXkoYXJyYXksIGksIHJlc3VsdCkgLSAxO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NpZ25LZXkobm9kZTogTm9kZSwga2V5OiBDaGlsZEtleSwgcmVzdWx0OiBOb2RlIHwgTm9kZVtdIHwgbnVsbCkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIG5vZGVba2V5XSA9IHJlc3VsdFswXTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIG5vZGVba2V5XSA9IHJlc3VsdDtcbiAgfVxufVxuXG5mdW5jdGlvbiBzcGxpY2VBcnJheShhcnJheTogTm9kZVtdLCBpbmRleDogbnVtYmVyLCByZXN1bHQ6IE5vZGUgfCBOb2RlW10gfCBudWxsKSB7XG4gIGlmIChyZXN1bHQgPT09IG51bGwpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIHJldHVybiAwO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgLi4ucmVzdWx0KTtcbiAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aDtcbiAgfSBlbHNlIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIHJlc3VsdCk7XG4gICAgcmV0dXJuIDE7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdHJhdmVyc2Uobm9kZTogTm9kZSwgdmlzaXRvcjogTm9kZVZpc2l0b3IpIHtcbiAgdmlzaXROb2RlKHZpc2l0b3IsIG5vZGUpO1xufVxuIl19