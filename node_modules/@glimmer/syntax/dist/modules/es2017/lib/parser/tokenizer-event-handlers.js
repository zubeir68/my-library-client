import b, { SYNTHETIC } from '../builders';
import { appendChild, parseElementBlockParams } from '../utils';
import { HandlebarsNodeVisitors } from './handlebars-node-visitors';
import SyntaxError from '../errors/syntax-error';
import builders from '../builders';
import traverse from '../traversal/traverse';
import print from '../generation/print';
import Walker from '../traversal/walker';
import * as handlebars from 'handlebars';
import { assign } from '@glimmer/util';
export const voidMap = Object.create(null);
let voidTagNames = 'area base br col command embed hr img input keygen link meta param source track wbr';
voidTagNames.split(' ').forEach(tagName => {
    voidMap[tagName] = true;
});
export class TokenizerEventHandlers extends HandlebarsNodeVisitors {
    constructor() {
        super(...arguments);
        this.tagOpenLine = 0;
        this.tagOpenColumn = 0;
    }
    reset() {
        this.currentNode = null;
    }
    // Comment
    beginComment() {
        this.currentNode = b.comment('');
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tagOpenLine, this.tagOpenColumn),
            end: null
        };
    }
    appendToCommentData(char) {
        this.currentComment.value += char;
    }
    finishComment() {
        this.currentComment.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentComment);
    }
    // Data
    beginData() {
        this.currentNode = b.text();
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            end: null
        };
    }
    appendToData(char) {
        this.currentData.chars += char;
    }
    finishData() {
        this.currentData.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentData);
    }
    // Tags - basic
    tagOpen() {
        this.tagOpenLine = this.tokenizer.line;
        this.tagOpenColumn = this.tokenizer.column;
    }
    beginStartTag() {
        this.currentNode = {
            type: 'StartTag',
            name: '',
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    }
    beginEndTag() {
        this.currentNode = {
            type: 'EndTag',
            name: '',
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    }
    finishTag() {
        let { line, column } = this.tokenizer;
        let tag = this.currentTag;
        tag.loc = b.loc(this.tagOpenLine, this.tagOpenColumn, line, column);
        if (tag.type === 'StartTag') {
            this.finishStartTag();
            if (voidMap[tag.name] || tag.selfClosing) {
                this.finishEndTag(true);
            }
        } else if (tag.type === 'EndTag') {
            this.finishEndTag(false);
        }
    }
    finishStartTag() {
        let { name, attributes, modifiers, comments, selfClosing } = this.currentStartTag;
        let loc = b.loc(this.tagOpenLine, this.tagOpenColumn);
        let element = b.element({ name, selfClosing }, attributes, modifiers, [], comments, [], loc);
        this.elementStack.push(element);
    }
    finishEndTag(isVoid) {
        let tag = this.currentTag;
        let element = this.elementStack.pop();
        let parent = this.currentElement();
        validateEndTag(tag, element, isVoid);
        element.loc.end.line = this.tokenizer.line;
        element.loc.end.column = this.tokenizer.column;
        parseElementBlockParams(element);
        appendChild(parent, element);
    }
    markTagAsSelfClosing() {
        this.currentTag.selfClosing = true;
    }
    // Tags - name
    appendToTagName(char) {
        this.currentTag.name += char;
    }
    // Tags - attributes
    beginAttribute() {
        let tag = this.currentTag;
        if (tag.type === 'EndTag') {
            throw new SyntaxError(`Invalid end tag: closing tag must not have attributes, ` + `in \`${tag.name}\` (on line ${this.tokenizer.line}).`, tag.loc);
        }
        this.currentAttribute = {
            name: '',
            parts: [],
            isQuoted: false,
            isDynamic: false,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            valueStartLine: 0,
            valueStartColumn: 0
        };
    }
    appendToAttributeName(char) {
        this.currentAttr.name += char;
    }
    beginAttributeValue(isQuoted) {
        this.currentAttr.isQuoted = isQuoted;
        this.currentAttr.valueStartLine = this.tokenizer.line;
        this.currentAttr.valueStartColumn = this.tokenizer.column;
    }
    appendToAttributeValue(char) {
        let parts = this.currentAttr.parts;
        let lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.type === 'TextNode') {
            lastPart.chars += char;
            // update end location for each added char
            lastPart.loc.end.line = this.tokenizer.line;
            lastPart.loc.end.column = this.tokenizer.column;
        } else {
            // initially assume the text node is a single char
            let loc = b.loc(this.tokenizer.line, this.tokenizer.column, this.tokenizer.line, this.tokenizer.column);
            // correct for `\n` as first char
            if (char === '\n') {
                loc.start.line -= 1;
                loc.start.column = lastPart ? lastPart.loc.end.column : this.currentAttr.valueStartColumn;
            }
            let text = b.text(char, loc);
            parts.push(text);
        }
    }
    finishAttributeValue() {
        let { name, parts, isQuoted, isDynamic, valueStartLine, valueStartColumn } = this.currentAttr;
        let value = assembleAttributeValue(parts, isQuoted, isDynamic, this.tokenizer.line);
        value.loc = b.loc(valueStartLine, valueStartColumn, this.tokenizer.line, this.tokenizer.column);
        let loc = b.loc(this.currentAttr.start.line, this.currentAttr.start.column, this.tokenizer.line, this.tokenizer.column);
        let attribute = b.attr(name, value, loc);
        this.currentStartTag.attributes.push(attribute);
    }
    reportSyntaxError(message) {
        throw new SyntaxError(`Syntax error at line ${this.tokenizer.line} col ${this.tokenizer.column}: ${message}`, b.loc(this.tokenizer.line, this.tokenizer.column));
    }
}
function assembleAttributeValue(parts, isQuoted, isDynamic, line) {
    if (isDynamic) {
        if (isQuoted) {
            return assembleConcatenatedValue(parts);
        } else {
            if (parts.length === 1 || parts.length === 2 && parts[1].type === 'TextNode' && parts[1].chars === '/') {
                return parts[0];
            } else {
                throw new SyntaxError(`An unquoted attribute value must be a string or a mustache, ` + `preceeded by whitespace or a '=' character, and ` + `followed by whitespace, a '>' character, or '/>' (on line ${line})`, b.loc(line, 0));
            }
        }
    } else {
        return parts.length > 0 ? parts[0] : b.text('');
    }
}
function assembleConcatenatedValue(parts) {
    for (let i = 0; i < parts.length; i++) {
        let part = parts[i];
        if (part.type !== 'MustacheStatement' && part.type !== 'TextNode') {
            throw new SyntaxError('Unsupported node in quoted attribute value: ' + part['type'], part.loc);
        }
    }
    return b.concat(parts);
}
function validateEndTag(tag, element, selfClosing) {
    let error;
    if (voidMap[tag.name] && !selfClosing) {
        // EngTag is also called by StartTag for void and self-closing tags (i.e.
        // <input> or <br />, so we need to check for that here. Otherwise, we would
        // throw an error for those cases.
        error = 'Invalid end tag ' + formatEndTagInfo(tag) + ' (void elements cannot have end tags).';
    } else if (element.tag === undefined) {
        error = 'Closing tag ' + formatEndTagInfo(tag) + ' without an open tag.';
    } else if (element.tag !== tag.name) {
        error = 'Closing tag ' + formatEndTagInfo(tag) + ' did not match last open tag `' + element.tag + '` (on line ' + element.loc.start.line + ').';
    }
    if (error) {
        throw new SyntaxError(error, element.loc);
    }
}
function formatEndTagInfo(tag) {
    return '`' + tag.name + '` (on line ' + tag.loc.end.line + ')';
}
const syntax = {
    parse: preprocess,
    builders,
    print,
    traverse,
    Walker
};
export function preprocess(html, options) {
    let ast = typeof html === 'object' ? html : handlebars.parse(html);
    let program = new TokenizerEventHandlers(html).acceptNode(ast);
    if (options && options.plugins && options.plugins.ast) {
        for (let i = 0, l = options.plugins.ast.length; i < l; i++) {
            let transform = options.plugins.ast[i];
            let env = assign({}, options, { syntax }, { plugins: undefined });
            let pluginResult = transform(env);
            traverse(program, pluginResult.visitor);
        }
    }
    return program;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIvdG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sQUFBQyxBQUFFLEtBQUUsQUFBUyxBQUFFLGlCQUFNLEFBQWEsQUFBQztBQUMzQyxBQUFPLFNBQUUsQUFBVyxhQUFFLEFBQXVCLEFBQUUsK0JBQU0sQUFBVSxBQUFDO0FBQ2hFLEFBQU8sU0FBRSxBQUFzQixBQUFFLDhCQUFNLEFBQTRCLEFBQUM7QUFFcEUsT0FBTyxBQUFXLGlCQUFNLEFBQXdCLEFBQUM7QUFFakQsT0FBTyxBQUFRLGNBQU0sQUFBYSxBQUFDO0FBQ25DLE9BQU8sQUFBUSxjQUFNLEFBQXVCLEFBQUM7QUFFN0MsT0FBTyxBQUFLLFdBQU0sQUFBcUIsQUFBQztBQUN4QyxPQUFPLEFBQU0sWUFBTSxBQUFxQixBQUFDO0FBQ3pDLE9BQU8sS0FBSyxBQUFVLGdCQUFNLEFBQVksQUFBQztBQUN6QyxBQUFPLFNBQUUsQUFBTSxBQUFFLGNBQU0sQUFBZSxBQUFDO0FBRXZDLEFBQU0sT0FBQyxNQUFNLEFBQU8sVUFFaEIsQUFBTSxPQUFDLEFBQU0sT0FBQyxBQUFJLEFBQUMsQUFBQztBQUV4QixJQUFJLEFBQVksZUFDZCxBQUFxRixBQUFDO0FBQ3hGLEFBQVksYUFBQyxBQUFLLE1BQUMsQUFBRyxBQUFDLEtBQUMsQUFBTyxRQUFDLEFBQU8sQUFBQyxBQUFFO0FBQ3hDLEFBQU8sWUFBQyxBQUFPLEFBQUMsV0FBRyxBQUFJLEFBQUMsQUFDMUI7QUFBQyxBQUFDLEFBQUM7QUFFSCxBQUFNLGFBQThCLCtCQUFRLEFBQXNCO0FBQWxFOztBQUNVLGFBQVcsY0FBRyxBQUFDLEFBQUM7QUFDaEIsYUFBYSxnQkFBRyxBQUFDLEFBQUMsQUFzTjVCO0FBQUM7QUFwTkMs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Q3JELGFBQUssSUFBSSxBQUFDLElBQUcsQUFBQyxHQUFFLEFBQUMsSUFBRyxBQUFPLFFBQUMsQUFBTyxRQUFDLEFBQUcsSUFBQyxBQUFNLFFBQUUsQUFBQyxJQUFHLEFBQUMsR0FBRSxBQUFDLEFBQUUsS0FBRTtBQUMxRCxnQkFBSSxBQUFTLFlBQUcsQUFBTyxRQUFDLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBQyxBQUFDLEFBQUM7QUFDdkMsZ0JBQUksQUFBRyxNQUFHLEFBQU0sT0FBQyxBQUFFLElBQUUsQUFBTyxTQUFFLEVBQUUsQUFBTSxBQUFFLFVBQUUsRUFBRSxBQUFPLFNBQUUsQUFBUyxBQUFFLEFBQUMsQUFBQztBQUVsRSxnQkFBSSxBQUFZLGVBQUcsQUFBUyxVQUFDLEFBQUcsQUFBQyxBQUFDO0FBRWxDLEFBQVEscUJBQUMsQUFBTyxTQUFFLEFBQVksYUFBQyxBQUFPLEFBQUMsQUFBQztBQUN6QztBQUNGO0FBRUQsV0FBTyxBQUFPLEFBQUMsQUFDakI7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBiLCB7IFNZTlRIRVRJQyB9IGZyb20gJy4uL2J1aWxkZXJzJztcbmltcG9ydCB7IGFwcGVuZENoaWxkLCBwYXJzZUVsZW1lbnRCbG9ja1BhcmFtcyB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IEhhbmRsZWJhcnNOb2RlVmlzaXRvcnMgfSBmcm9tICcuL2hhbmRsZWJhcnMtbm9kZS12aXNpdG9ycyc7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0IFN5bnRheEVycm9yIGZyb20gJy4uL2Vycm9ycy9zeW50YXgtZXJyb3InO1xuaW1wb3J0IHsgVGFnIH0gZnJvbSAnLi4vcGFyc2VyJztcbmltcG9ydCBidWlsZGVycyBmcm9tICcuLi9idWlsZGVycyc7XG5pbXBvcnQgdHJhdmVyc2UgZnJvbSAnLi4vdHJhdmVyc2FsL3RyYXZlcnNlJztcbmltcG9ydCB7IE5vZGVWaXNpdG9yIH0gZnJvbSAnLi4vdHlwZXMvdmlzaXRvcic7XG5pbXBvcnQgcHJpbnQgZnJvbSAnLi4vZ2VuZXJhdGlvbi9wcmludCc7XG5pbXBvcnQgV2Fsa2VyIGZyb20gJy4uL3RyYXZlcnNhbC93YWxrZXInO1xuaW1wb3J0ICogYXMgaGFuZGxlYmFycyBmcm9tICdoYW5kbGViYXJzJztcbmltcG9ydCB7IGFzc2lnbiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5leHBvcnQgY29uc3Qgdm9pZE1hcDoge1xuICBbdGFnTmFtZTogc3RyaW5nXTogYm9vbGVhbjtcbn0gPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG5sZXQgdm9pZFRhZ05hbWVzID1cbiAgJ2FyZWEgYmFzZSBiciBjb2wgY29tbWFuZCBlbWJlZCBociBpbWcgaW5wdXQga2V5Z2VuIGxpbmsgbWV0YSBwYXJhbSBzb3VyY2UgdHJhY2sgd2JyJztcbnZvaWRUYWdOYW1lcy5zcGxpdCgnICcpLmZvckVhY2godGFnTmFtZSA9PiB7XG4gIHZvaWRNYXBbdGFnTmFtZV0gPSB0cnVlO1xufSk7XG5cbmV4cG9ydCBjbGFzcyBUb2tlbml6ZXJFdmVudEhhbmRsZXJzIGV4dGVuZHMgSGFuZGxlYmFyc05vZGVWaXNpdG9ycyB7XG4gIHByaXZhdGUgdGFnT3BlbkxpbmUgPSAwO1xuICBwcml2YXRlIHRhZ09wZW5Db2x1bW4gPSAwO1xuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBudWxsO1xuICB9XG5cbiAgLy8gQ29tbWVudFxuXG4gIGJlZ2luQ29tbWVudCgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gYi5jb21tZW50KCcnKTtcbiAgICB0aGlzLmN1cnJlbnROb2RlLmxvYyA9IHtcbiAgICAgIHNvdXJjZTogbnVsbCxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4pLFxuICAgICAgZW5kOiAobnVsbCBhcyBhbnkpIGFzIEFTVC5Qb3NpdGlvbixcbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9Db21tZW50RGF0YShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRDb21tZW50LnZhbHVlICs9IGNoYXI7XG4gIH1cblxuICBmaW5pc2hDb21tZW50KCkge1xuICAgIHRoaXMuY3VycmVudENvbW1lbnQubG9jLmVuZCA9IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHRoaXMuY3VycmVudENvbW1lbnQpO1xuICB9XG5cbiAgLy8gRGF0YVxuXG4gIGJlZ2luRGF0YSgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gYi50ZXh0KCk7XG4gICAgdGhpcy5jdXJyZW50Tm9kZS5sb2MgPSB7XG4gICAgICBzb3VyY2U6IG51bGwsXG4gICAgICBzdGFydDogYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKSxcbiAgICAgIGVuZDogKG51bGwgYXMgYW55KSBhcyBBU1QuUG9zaXRpb24sXG4gICAgfTtcbiAgfVxuXG4gIGFwcGVuZFRvRGF0YShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnREYXRhLmNoYXJzICs9IGNoYXI7XG4gIH1cblxuICBmaW5pc2hEYXRhKCkge1xuICAgIHRoaXMuY3VycmVudERhdGEubG9jLmVuZCA9IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHRoaXMuY3VycmVudERhdGEpO1xuICB9XG5cbiAgLy8gVGFncyAtIGJhc2ljXG5cbiAgdGFnT3BlbigpIHtcbiAgICB0aGlzLnRhZ09wZW5MaW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICB0aGlzLnRhZ09wZW5Db2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gIH1cblxuICBiZWdpblN0YXJ0VGFnKCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSB7XG4gICAgICB0eXBlOiAnU3RhcnRUYWcnLFxuICAgICAgbmFtZTogJycsXG4gICAgICBhdHRyaWJ1dGVzOiBbXSxcbiAgICAgIG1vZGlmaWVyczogW10sXG4gICAgICBjb21tZW50czogW10sXG4gICAgICBzZWxmQ2xvc2luZzogZmFsc2UsXG4gICAgICBsb2M6IFNZTlRIRVRJQyxcbiAgICB9O1xuICB9XG5cbiAgYmVnaW5FbmRUYWcoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IHtcbiAgICAgIHR5cGU6ICdFbmRUYWcnLFxuICAgICAgbmFtZTogJycsXG4gICAgICBhdHRyaWJ1dGVzOiBbXSxcbiAgICAgIG1vZGlmaWVyczogW10sXG4gICAgICBjb21tZW50czogW10sXG4gICAgICBzZWxmQ2xvc2luZzogZmFsc2UsXG4gICAgICBsb2M6IFNZTlRIRVRJQyxcbiAgICB9O1xuICB9XG5cbiAgZmluaXNoVGFnKCkge1xuICAgIGxldCB7IGxpbmUsIGNvbHVtbiB9ID0gdGhpcy50b2tlbml6ZXI7XG5cbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuICAgIHRhZy5sb2MgPSBiLmxvYyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4sIGxpbmUsIGNvbHVtbik7XG5cbiAgICBpZiAodGFnLnR5cGUgPT09ICdTdGFydFRhZycpIHtcbiAgICAgIHRoaXMuZmluaXNoU3RhcnRUYWcoKTtcblxuICAgICAgaWYgKHZvaWRNYXBbdGFnLm5hbWVdIHx8IHRhZy5zZWxmQ2xvc2luZykge1xuICAgICAgICB0aGlzLmZpbmlzaEVuZFRhZyh0cnVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRhZy50eXBlID09PSAnRW5kVGFnJykge1xuICAgICAgdGhpcy5maW5pc2hFbmRUYWcoZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGZpbmlzaFN0YXJ0VGFnKCkge1xuICAgIGxldCB7IG5hbWUsIGF0dHJpYnV0ZXMsIG1vZGlmaWVycywgY29tbWVudHMsIHNlbGZDbG9zaW5nIH0gPSB0aGlzLmN1cnJlbnRTdGFydFRhZztcbiAgICBsZXQgbG9jID0gYi5sb2ModGhpcy50YWdPcGVuTGluZSwgdGhpcy50YWdPcGVuQ29sdW1uKTtcbiAgICBsZXQgZWxlbWVudCA9IGIuZWxlbWVudCh7IG5hbWUsIHNlbGZDbG9zaW5nIH0sIGF0dHJpYnV0ZXMsIG1vZGlmaWVycywgW10sIGNvbW1lbnRzLCBbXSwgbG9jKTtcbiAgICB0aGlzLmVsZW1lbnRTdGFjay5wdXNoKGVsZW1lbnQpO1xuICB9XG5cbiAgZmluaXNoRW5kVGFnKGlzVm9pZDogYm9vbGVhbikge1xuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG5cbiAgICBsZXQgZWxlbWVudCA9IHRoaXMuZWxlbWVudFN0YWNrLnBvcCgpIGFzIEFTVC5FbGVtZW50Tm9kZTtcbiAgICBsZXQgcGFyZW50ID0gdGhpcy5jdXJyZW50RWxlbWVudCgpO1xuXG4gICAgdmFsaWRhdGVFbmRUYWcodGFnLCBlbGVtZW50LCBpc1ZvaWQpO1xuXG4gICAgZWxlbWVudC5sb2MuZW5kLmxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIGVsZW1lbnQubG9jLmVuZC5jb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG5cbiAgICBwYXJzZUVsZW1lbnRCbG9ja1BhcmFtcyhlbGVtZW50KTtcbiAgICBhcHBlbmRDaGlsZChwYXJlbnQsIGVsZW1lbnQpO1xuICB9XG5cbiAgbWFya1RhZ0FzU2VsZkNsb3NpbmcoKSB7XG4gICAgdGhpcy5jdXJyZW50VGFnLnNlbGZDbG9zaW5nID0gdHJ1ZTtcbiAgfVxuXG4gIC8vIFRhZ3MgLSBuYW1lXG5cbiAgYXBwZW5kVG9UYWdOYW1lKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudFRhZy5uYW1lICs9IGNoYXI7XG4gIH1cblxuICAvLyBUYWdzIC0gYXR0cmlidXRlc1xuXG4gIGJlZ2luQXR0cmlidXRlKCkge1xuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG4gICAgaWYgKHRhZy50eXBlID09PSAnRW5kVGFnJykge1xuICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICBgSW52YWxpZCBlbmQgdGFnOiBjbG9zaW5nIHRhZyBtdXN0IG5vdCBoYXZlIGF0dHJpYnV0ZXMsIGAgK1xuICAgICAgICAgIGBpbiBcXGAke3RhZy5uYW1lfVxcYCAob24gbGluZSAke3RoaXMudG9rZW5pemVyLmxpbmV9KS5gLFxuICAgICAgICB0YWcubG9jXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuY3VycmVudEF0dHJpYnV0ZSA9IHtcbiAgICAgIG5hbWU6ICcnLFxuICAgICAgcGFydHM6IFtdLFxuICAgICAgaXNRdW90ZWQ6IGZhbHNlLFxuICAgICAgaXNEeW5hbWljOiBmYWxzZSxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pLFxuICAgICAgdmFsdWVTdGFydExpbmU6IDAsXG4gICAgICB2YWx1ZVN0YXJ0Q29sdW1uOiAwLFxuICAgIH07XG4gIH1cblxuICBhcHBlbmRUb0F0dHJpYnV0ZU5hbWUoY2hhcjogc3RyaW5nKSB7XG4gICAgdGhpcy5jdXJyZW50QXR0ci5uYW1lICs9IGNoYXI7XG4gIH1cblxuICBiZWdpbkF0dHJpYnV0ZVZhbHVlKGlzUXVvdGVkOiBib29sZWFuKSB7XG4gICAgdGhpcy5jdXJyZW50QXR0ci5pc1F1b3RlZCA9IGlzUXVvdGVkO1xuICAgIHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydExpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydENvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgfVxuXG4gIGFwcGVuZFRvQXR0cmlidXRlVmFsdWUoY2hhcjogc3RyaW5nKSB7XG4gICAgbGV0IHBhcnRzID0gdGhpcy5jdXJyZW50QXR0ci5wYXJ0cztcbiAgICBsZXQgbGFzdFBhcnQgPSBwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXTtcblxuICAgIGlmIChsYXN0UGFydCAmJiBsYXN0UGFydC50eXBlID09PSAnVGV4dE5vZGUnKSB7XG4gICAgICBsYXN0UGFydC5jaGFycyArPSBjaGFyO1xuXG4gICAgICAvLyB1cGRhdGUgZW5kIGxvY2F0aW9uIGZvciBlYWNoIGFkZGVkIGNoYXJcbiAgICAgIGxhc3RQYXJ0LmxvYy5lbmQubGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmU7XG4gICAgICBsYXN0UGFydC5sb2MuZW5kLmNvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gaW5pdGlhbGx5IGFzc3VtZSB0aGUgdGV4dCBub2RlIGlzIGEgc2luZ2xlIGNoYXJcbiAgICAgIGxldCBsb2MgPSBiLmxvYyhcbiAgICAgICAgdGhpcy50b2tlbml6ZXIubGluZSxcbiAgICAgICAgdGhpcy50b2tlbml6ZXIuY29sdW1uLFxuICAgICAgICB0aGlzLnRva2VuaXplci5saW5lLFxuICAgICAgICB0aGlzLnRva2VuaXplci5jb2x1bW5cbiAgICAgICk7XG5cbiAgICAgIC8vIGNvcnJlY3QgZm9yIGBcXG5gIGFzIGZpcnN0IGNoYXJcbiAgICAgIGlmIChjaGFyID09PSAnXFxuJykge1xuICAgICAgICBsb2Muc3RhcnQubGluZSAtPSAxO1xuICAgICAgICBsb2Muc3RhcnQuY29sdW1uID0gbGFzdFBhcnQgPyBsYXN0UGFydC5sb2MuZW5kLmNvbHVtbiA6IHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydENvbHVtbjtcbiAgICAgIH1cblxuICAgICAgbGV0IHRleHQgPSBiLnRleHQoY2hhciwgbG9jKTtcbiAgICAgIHBhcnRzLnB1c2godGV4dCk7XG4gICAgfVxuICB9XG5cbiAgZmluaXNoQXR0cmlidXRlVmFsdWUoKSB7XG4gICAgbGV0IHsgbmFtZSwgcGFydHMsIGlzUXVvdGVkLCBpc0R5bmFtaWMsIHZhbHVlU3RhcnRMaW5lLCB2YWx1ZVN0YXJ0Q29sdW1uIH0gPSB0aGlzLmN1cnJlbnRBdHRyO1xuICAgIGxldCB2YWx1ZSA9IGFzc2VtYmxlQXR0cmlidXRlVmFsdWUocGFydHMsIGlzUXVvdGVkLCBpc0R5bmFtaWMsIHRoaXMudG9rZW5pemVyLmxpbmUpO1xuICAgIHZhbHVlLmxvYyA9IGIubG9jKHZhbHVlU3RhcnRMaW5lLCB2YWx1ZVN0YXJ0Q29sdW1uLCB0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pO1xuXG4gICAgbGV0IGxvYyA9IGIubG9jKFxuICAgICAgdGhpcy5jdXJyZW50QXR0ci5zdGFydC5saW5lLFxuICAgICAgdGhpcy5jdXJyZW50QXR0ci5zdGFydC5jb2x1bW4sXG4gICAgICB0aGlzLnRva2VuaXplci5saW5lLFxuICAgICAgdGhpcy50b2tlbml6ZXIuY29sdW1uXG4gICAgKTtcblxuICAgIGxldCBhdHRyaWJ1dGUgPSBiLmF0dHIobmFtZSwgdmFsdWUsIGxvYyk7XG5cbiAgICB0aGlzLmN1cnJlbnRTdGFydFRhZy5hdHRyaWJ1dGVzLnB1c2goYXR0cmlidXRlKTtcbiAgfVxuXG4gIHJlcG9ydFN5bnRheEVycm9yKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgIGBTeW50YXggZXJyb3IgYXQgbGluZSAke3RoaXMudG9rZW5pemVyLmxpbmV9IGNvbCAke3RoaXMudG9rZW5pemVyLmNvbHVtbn06ICR7bWVzc2FnZX1gLFxuICAgICAgYi5sb2ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKVxuICAgICk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzZW1ibGVBdHRyaWJ1dGVWYWx1ZShcbiAgcGFydHM6IChBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUpW10sXG4gIGlzUXVvdGVkOiBib29sZWFuLFxuICBpc0R5bmFtaWM6IGJvb2xlYW4sXG4gIGxpbmU6IG51bWJlclxuKSB7XG4gIGlmIChpc0R5bmFtaWMpIHtcbiAgICBpZiAoaXNRdW90ZWQpIHtcbiAgICAgIHJldHVybiBhc3NlbWJsZUNvbmNhdGVuYXRlZFZhbHVlKHBhcnRzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKFxuICAgICAgICBwYXJ0cy5sZW5ndGggPT09IDEgfHxcbiAgICAgICAgKHBhcnRzLmxlbmd0aCA9PT0gMiAmJlxuICAgICAgICAgIHBhcnRzWzFdLnR5cGUgPT09ICdUZXh0Tm9kZScgJiZcbiAgICAgICAgICAocGFydHNbMV0gYXMgQVNULlRleHROb2RlKS5jaGFycyA9PT0gJy8nKVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiBwYXJ0c1swXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgICBgQW4gdW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlIG11c3QgYmUgYSBzdHJpbmcgb3IgYSBtdXN0YWNoZSwgYCArXG4gICAgICAgICAgICBgcHJlY2VlZGVkIGJ5IHdoaXRlc3BhY2Ugb3IgYSAnPScgY2hhcmFjdGVyLCBhbmQgYCArXG4gICAgICAgICAgICBgZm9sbG93ZWQgYnkgd2hpdGVzcGFjZSwgYSAnPicgY2hhcmFjdGVyLCBvciAnLz4nIChvbiBsaW5lICR7bGluZX0pYCxcbiAgICAgICAgICBiLmxvYyhsaW5lLCAwKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcGFydHMubGVuZ3RoID4gMCA/IHBhcnRzWzBdIDogYi50ZXh0KCcnKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlbWJsZUNvbmNhdGVuYXRlZFZhbHVlKHBhcnRzOiAoQVNULk11c3RhY2hlU3RhdGVtZW50IHwgQVNULlRleHROb2RlKVtdKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgcGFydDogQVNULkJhc2VOb2RlID0gcGFydHNbaV07XG5cbiAgICBpZiAocGFydC50eXBlICE9PSAnTXVzdGFjaGVTdGF0ZW1lbnQnICYmIHBhcnQudHlwZSAhPT0gJ1RleHROb2RlJykge1xuICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICAnVW5zdXBwb3J0ZWQgbm9kZSBpbiBxdW90ZWQgYXR0cmlidXRlIHZhbHVlOiAnICsgcGFydFsndHlwZSddLFxuICAgICAgICBwYXJ0LmxvY1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gYi5jb25jYXQocGFydHMpO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUVuZFRhZyhcbiAgdGFnOiBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPixcbiAgZWxlbWVudDogQVNULkVsZW1lbnROb2RlLFxuICBzZWxmQ2xvc2luZzogYm9vbGVhblxuKSB7XG4gIGxldCBlcnJvcjtcblxuICBpZiAodm9pZE1hcFt0YWcubmFtZV0gJiYgIXNlbGZDbG9zaW5nKSB7XG4gICAgLy8gRW5nVGFnIGlzIGFsc28gY2FsbGVkIGJ5IFN0YXJ0VGFnIGZvciB2b2lkIGFuZCBzZWxmLWNsb3NpbmcgdGFncyAoaS5lLlxuICAgIC8vIDxpbnB1dD4gb3IgPGJyIC8+LCBzbyB3ZSBuZWVkIHRvIGNoZWNrIGZvciB0aGF0IGhlcmUuIE90aGVyd2lzZSwgd2Ugd291bGRcbiAgICAvLyB0aHJvdyBhbiBlcnJvciBmb3IgdGhvc2UgY2FzZXMuXG4gICAgZXJyb3IgPSAnSW52YWxpZCBlbmQgdGFnICcgKyBmb3JtYXRFbmRUYWdJbmZvKHRhZykgKyAnICh2b2lkIGVsZW1lbnRzIGNhbm5vdCBoYXZlIGVuZCB0YWdzKS4nO1xuICB9IGVsc2UgaWYgKGVsZW1lbnQudGFnID09PSB1bmRlZmluZWQpIHtcbiAgICBlcnJvciA9ICdDbG9zaW5nIHRhZyAnICsgZm9ybWF0RW5kVGFnSW5mbyh0YWcpICsgJyB3aXRob3V0IGFuIG9wZW4gdGFnLic7XG4gIH0gZWxzZSBpZiAoZWxlbWVudC50YWcgIT09IHRhZy5uYW1lKSB7XG4gICAgZXJyb3IgPVxuICAgICAgJ0Nsb3NpbmcgdGFnICcgK1xuICAgICAgZm9ybWF0RW5kVGFnSW5mbyh0YWcpICtcbiAgICAgICcgZGlkIG5vdCBtYXRjaCBsYXN0IG9wZW4gdGFnIGAnICtcbiAgICAgIGVsZW1lbnQudGFnICtcbiAgICAgICdgIChvbiBsaW5lICcgK1xuICAgICAgZWxlbWVudC5sb2Muc3RhcnQubGluZSArXG4gICAgICAnKS4nO1xuICB9XG5cbiAgaWYgKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGVycm9yLCBlbGVtZW50LmxvYyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZm9ybWF0RW5kVGFnSW5mbyh0YWc6IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+KSB7XG4gIHJldHVybiAnYCcgKyB0YWcubmFtZSArICdgIChvbiBsaW5lICcgKyB0YWcubG9jLmVuZC5saW5lICsgJyknO1xufVxuXG4vKipcbiAgQVNUUGx1Z2lucyBjYW4gbWFrZSBjaGFuZ2VzIHRvIHRoZSBHbGltbWVyIHRlbXBsYXRlIEFTVCBiZWZvcmVcbiAgY29tcGlsYXRpb24gYmVnaW5zLlxuKi9cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luQnVpbGRlciB7XG4gIChlbnY6IEFTVFBsdWdpbkVudmlyb25tZW50KTogQVNUUGx1Z2luO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFTVFBsdWdpbiB7XG4gIG5hbWU6IHN0cmluZztcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3I7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luRW52aXJvbm1lbnQge1xuICBtZXRhPzogYW55O1xuICBzeW50YXg6IFN5bnRheDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcmVwcm9jZXNzT3B0aW9ucyB7XG4gIHBsdWdpbnM/OiB7XG4gICAgYXN0PzogQVNUUGx1Z2luQnVpbGRlcltdO1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN5bnRheCB7XG4gIHBhcnNlOiB0eXBlb2YgcHJlcHJvY2VzcztcbiAgYnVpbGRlcnM6IHR5cGVvZiBidWlsZGVycztcbiAgcHJpbnQ6IHR5cGVvZiBwcmludDtcbiAgdHJhdmVyc2U6IHR5cGVvZiB0cmF2ZXJzZTtcbiAgV2Fsa2VyOiB0eXBlb2YgV2Fsa2VyO1xufVxuXG5jb25zdCBzeW50YXg6IFN5bnRheCA9IHtcbiAgcGFyc2U6IHByZXByb2Nlc3MsXG4gIGJ1aWxkZXJzLFxuICBwcmludCxcbiAgdHJhdmVyc2UsXG4gIFdhbGtlcixcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmVwcm9jZXNzKGh0bWw6IHN0cmluZywgb3B0aW9ucz86IFByZXByb2Nlc3NPcHRpb25zKTogQVNULlByb2dyYW0ge1xuICBsZXQgYXN0ID0gdHlwZW9mIGh0bWwgPT09ICdvYmplY3QnID8gaHRtbCA6IGhhbmRsZWJhcnMucGFyc2UoaHRtbCk7XG4gIGxldCBwcm9ncmFtID0gbmV3IFRva2VuaXplckV2ZW50SGFuZGxlcnMoaHRtbCkuYWNjZXB0Tm9kZShhc3QpO1xuXG4gIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGx1Z2lucyAmJiBvcHRpb25zLnBsdWdpbnMuYXN0KSB7XG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBvcHRpb25zLnBsdWdpbnMuYXN0Lmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgbGV0IHRyYW5zZm9ybSA9IG9wdGlvbnMucGx1Z2lucy5hc3RbaV07XG4gICAgICBsZXQgZW52ID0gYXNzaWduKHt9LCBvcHRpb25zLCB7IHN5bnRheCB9LCB7IHBsdWdpbnM6IHVuZGVmaW5lZCB9KTtcblxuICAgICAgbGV0IHBsdWdpblJlc3VsdCA9IHRyYW5zZm9ybShlbnYpO1xuXG4gICAgICB0cmF2ZXJzZShwcm9ncmFtLCBwbHVnaW5SZXN1bHQudmlzaXRvcik7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHByb2dyYW07XG59XG4iXX0=